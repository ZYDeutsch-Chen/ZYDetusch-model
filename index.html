<!DOCTYPE html>
<html lang="zh" style="height:100%">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>至元德语 - 造句练习器 A1-1</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;touch-action:manipulation;-webkit-text-size-adjust:100%;text-size-adjust:100%}
html,body{width:100%;height:100%;min-height:100vh;overflow-x:hidden}
body{background:linear-gradient(135deg,rgba(26,42,108,0.9),rgba(178,31,31,0.9),rgba(26,42,108,0.9));background-repeat:no-repeat;background-size:cover;background-position:center;color:#333;line-height:1.6;padding:12px;min-height:100vh;display:flex;flex-direction:column}
.container{max-width:1200px;margin:0 auto;padding:12px;flex:1}
header{display:flex;flex-direction:column;justify-content:space-between;color:white;text-shadow:0 2px 4px rgba(0,0,0,0.3);margin-bottom:12px;padding:10px 0}
.header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.header-title{flex:1;min-width:0;max-width:100%}
h1{font-size:1.4rem;margin-bottom:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:100%}
.tool-description{background:rgba(255,255,255,0.2);border-radius:8px;padding:8px;font-size:0.85rem;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;line-height:1.4;max-height:3.2em;width:100%}
.mode-container{display:flex;flex-direction:column;min-width:150px}
.mode-title{font-weight:bold;font-size:0.95rem;opacity:0.9;margin-bottom:6px;text-align:right;white-space:nowrap}
.mode-selector{display:flex;gap:6px;width:100%}
.mode-btn{height:32px;line-height:32px;padding:0 10px;border-radius:18px;border:2px solid #ffcc00;color:#ffcc00;background:rgba(255,255,255,0.1);cursor:pointer;font-weight:bold;font-size:0.9rem;display:flex;align-items:center;justify-content:center;flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;transition:all 0.3s ease}
.mode-btn.active{background:#ffcc00;color:#1a2a6c}
.mode-btn:hover{background:rgba(255,204,0,0.3)}
.main-content{display:flex;flex-direction:column;gap:16px}
.exercise-section,.theory-section{background:rgba(255,255,255,0.92);border-radius:12px;padding:16px;box-shadow:0 5px 15px rgba(0,0,0,0.15)}
.section-title{font-size:1.3rem;color:#1a2a6c;margin-bottom:12px;border-bottom:2px solid #1a2a6c;text-align:center;padding-bottom:8px;position:relative}
.puzzle-container-wrapper{margin-top:18px;position:relative}
.puzzle-container{display:flex;flex-wrap:wrap;gap:11px;margin:0;justify-content:center}
.puzzle-slot{flex:0 0 auto;min-width:104px;max-width:138px;height:50px;border:2px dashed #1a2a6c;border-radius:8px;padding:2px;background:#f8f9fa;position:relative;text-align:center;display:flex;align-items:center;justify-content:center;margin-bottom:22px}
.puzzle-slot.punctuation-slot{min-width:90px;max-width:120px}
.puzzle-slot::before{content:attr(data-label);position:absolute;top:-24px;left:50%;transform:translateX(-50%);background:#1a2a6c;color:white;font-size:0.8rem;padding:3px 8px;border-radius:8px;white-space:nowrap;z-index:10}
.word-bank{display:flex;flex-wrap:wrap;gap:8px;margin:0;justify-content:center;min-height:70px;padding:9px 10px;background:rgba(0,0,0,0.03);border-radius:8px;transition:background 0.3s}
.word-bank.active{background:rgba(255,204,0,0.1)}
.puzzle-piece{background:#e3f2fd;padding:8px 12px;border-radius:6px;font-weight:bold;cursor:move;min-width:70px;text-align:center;height:40px;display:flex;align-items:center;justify-content:center;font-size:0.95rem;box-shadow:0 2px 4px rgba(0,0,0,0.1);user-select:none;-webkit-tap-highlight-color:transparent;position:relative;transition:all 0.2s ease}
.puzzle-piece:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,0.15)}
.puzzle-slot>.puzzle-piece{width:100%;height:100%;display:flex;align-items:center;justify-content:center;padding:0;min-width:auto;box-shadow:none}
.puzzle-piece.punctuation{background:#d7ccc8}
.puzzle-piece.empty-slot{background:#e3f2fd;border:none}
.puzzle-piece.empty-slot::after{content:""}
.controls{display:flex;flex-wrap:wrap;justify-content:center;gap:8px;margin-top:16px;position:relative}
.btn{padding:8px 14px;border-radius:8px;font-weight:bold;cursor:pointer;border:none;display:flex;align-items:center;justify-content:center;transition:all 0.2s ease;font-size:0.95rem;min-width:95px;flex:1;max-width:143px}
.btn-secondary{background:#6c757d;color:white}
.btn-secondary:hover{background:#5a6268}
.btn-success{background:#28a745;color:white}
.btn-success:hover{background:#218838}
.btn-submit{background:#ffcc00;color:#1a2a6c;font-weight:bold;min-width:132px;max-width:165px}
.btn-submit:hover{background:#e6b800}
.feedback{margin-top:16px;padding:12px;border-radius:8px;display:block;background:#d4edda;color:#155724;border:2px solid #c3e6cb;animation:fadeIn 0.5s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.feedback-header{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;margin-bottom:12px;gap:8px}
.feedback-title{font-size:1.2rem;color:#1a2a6c;font-weight:bold;flex:1;min-width:150px}
.current-score-container{font-size:1.3rem;font-weight:bold;min-width:100px;text-align:right}
.current-score-container.high{color:#28a745}
.current-score-container.low{color:#dc3545}
.score-details{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px}
.score-item{background:rgba(255,255,255,0.7);padding:8px;border-radius:8px;text-align:center}
.score-value{font-size:1.1rem;font-weight:bold;color:#1a2a6c;display:block;margin-top:4px}
.score-item.error .score-value{color:#dc3545}
.reference-answer{text-align:center;font-size:1.1rem;font-weight:bold;margin:12px 0;padding:8px;background:rgba(255,255,255,0.7);border-radius:8px;border-left:4px solid #1a2a6c}
.vocab-section{margin-bottom:8px;padding:2px;border-radius:8px}
.vocab-container{display:flex;flex-wrap:wrap;gap:6px;justify-content:center}
.vocab-item{background:white;padding:6px 10px;border-radius:5px;font-size:0.9rem;font-weight:500;color:#1a2a6c;min-width:80px;text-align:center;box-shadow:0 1px 3px rgba(0,0,0,0.1);flex:1;transition:transform 0.2s}
.vocab-item:hover{transform:scale(1.05)}
.copyright{text-align:center;font-size:0.85rem;margin-top:20px;padding:10px 15px;background:rgba(255,255,255,0.25);border-radius:8px;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,0.3);box-shadow:0 2px 6px rgba(0,0,0,0.2)}
.theory-card{background:#f8f9fa;border-radius:8px;padding:12px;margin-top:12px;border:1px solid #ddd;box-shadow:0 2px 5px rgba(0,0,0,0.05);font-size:0.95rem;width:100%}
.theory-card ul{padding-left:20px;margin:12px 0}
.theory-card li{margin-bottom:6px;line-height:1.5}
.theory-card li li{font-size:0.9em;line-height:1.4}
.advanced-tip{position:fixed;top:70px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,0.9);color:#1a2a6c;padding:8px 16px;border-radius:30px;box-shadow:0 4px 10px rgba(0,0,0,0.2);z-index:1000;opacity:0;transition:opacity 0.5s ease-in-out;pointer-events:none;font-weight:bold;max-width:90%;text-align:center;font-size:0.95rem}
.advanced-tip.show{opacity:1}
.btn-icon{margin-left:6px;font-size:1.05em}
.sentence-info{display:flex;flex-wrap:wrap;justify-content:center;align-items:center;margin-bottom:0;padding:10px;background:#e3f2fd;border-radius:8px;font-size:1rem;font-weight:bold;color:#1a2a6c;text-align:center}
.translation-text{text-decoration:underline;text-decoration-thickness:1.5px;text-underline-offset:3px;margin-left:4px;font-weight:bold;display:inline-block;margin-top:4px;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis}
.next-button-warning{position:absolute;top:-32px;left:50%;transform:translateX(-50%);background:#dc3545;color:white;padding:5px 12px;border-radius:20px;font-size:0.85rem;opacity:0;transition:opacity 0.3s ease;white-space:nowrap;pointer-events:none;width:max-content;max-width:90%}
.next-button-warning.show{opacity:1}
.reading-indicator{display:flex;gap:6px;align-items:center;justify-content:center;margin-top:0;position:absolute;right:12px;top:calc(50% - 15px);transform:translateY(-50%);pointer-events:none;z-index:1001}
.reading-dot{width:10px;height:10px;border-radius:50%;background:#bbb;transition:background .18s,box-shadow .18s}
.reading-indicator.speaking .dot1{animation:dot1Anim 1.2s linear infinite}
.reading-indicator.speaking .dot2{animation:dot2Anim 1.2s linear infinite}
.reading-indicator.speaking .dot3{animation:dot3Anim 1.2s linear infinite}
@keyframes dot1Anim{0%,100%{background:#4CAF50;box-shadow:0 0 8px rgba(76,175,80,0.95)}25%,50%,75%{background:#bbb;box-shadow:none}}
@keyframes dot2Anim{25%,75%{background:#4CAF50;box-shadow:0 0 8px rgba(76,175,80,0.95)}0%,50%,100%{background:#bbb;box-shadow:none}}
@keyframes dot3Anim{50%{background:#4CAF50;box-shadow:0 0 8px rgba(76,175,80,0.95)}0%,25%,75%,100%{background:#bbb;box-shadow:none}}
.file-upload-container{background:rgba(255,255,255,0.92);border-radius:12px;padding:16px;margin-top:16px;box-shadow:0 5px 15px rgba(0,0,0,0.15)}
.file-upload-header{display:flex;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:10px}
.file-upload-btn{background:#1a2a6c;color:white;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:bold;display:inline-flex;align-items:center;min-width:150px;justify-content:center;border:none;transition:background 0.2s}
.file-upload-btn:hover{background:#0e1a4a}
.file-upload-btn svg{margin-right:8px}
.file-name{margin-left:12px;font-size:0.9rem;color:#666;flex:1;min-width:200px}
.upload-status{margin-top:12px;padding:10px;border-radius:8px;text-align:center;font-weight:bold;display:none}
.upload-status.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb;display:block}
.upload-status.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;display:block}
.sentence-puzzle-header{position:relative;padding-bottom:6px}
@media (max-width:767px){.puzzle-piece{cursor:pointer}.puzzle-slot.filled{cursor:pointer}.puzzle-slot.filled .puzzle-piece{transform:scale(1.05);box-shadow:0 0 10px rgba(0,0,0,0.2)}.puzzle-slot.filled .puzzle-piece:hover{transform:scale(1.1);box-shadow:0 0 15px rgba(0,0,0,0.3)}.mobile-tip{display:block;text-align:center;font-size:0.85rem;color:#1a2a6c;background:rgba(255,255,255,0.4);padding:6px;border-radius:6px;margin-top:8px}.upload-status{max-width:48%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.upload-status-container{width:100%;display:flex;justify-content:flex-end}.vocab-item{max-width:100%;word-break:break-word;overflow-wrap:anywhere;font-size:0.8rem}.vocab-item.long{font-size:0.75rem}.container{max-width:100%;width:100%;margin:0;padding:12px}.header-grid{grid-template-columns:1fr;grid-template-areas:"left";gap:10px}.header-right{margin-top:10px}.mode-selector{flex-direction:row;gap:8px}.mode-btn{font-size:0.9rem;padding:6px 12px}.upload-row{flex-direction:column;gap:8px}.upload-controls{flex-direction:column;gap:8px;min-width:100%}.file-upload-btn{font-size:0.85rem;padding:6px 10px;min-width:120px}.corpus-hint{width:100%;font-size:0.8rem;padding:6px}.upload-status-container{justify-content:center}}
@media (min-width:768px){.mobile-tip{display:none}.container{padding:20px}header{flex-direction:row;align-items:flex-end;padding:0;margin-bottom:20px}.header-top{flex-direction:row;align-items:flex-end;margin-bottom:0}.header-title{margin-right:20px;max-width:calc(100% - 200px)}h1{font-size:1.8rem;max-width:100%}.tool-description{font-size:0.95rem;padding:10px;max-height:none;-webkit-line-clamp:unset;max-width:100%}.mode-container{min-width:180px}.mode-title{font-size:1.05rem}.mode-btn{font-size:1rem;height:36px}.main-content{display:grid;grid-template-columns:1fr 350px;gap:20px}.section-title{font-size:1.5rem}.puzzle-container{justify-content:center;gap:11px}.puzzle-slot{min-width:115px;max-width:173px;margin-bottom:22px}.puzzle-slot.punctuation-slot{min-width:100px;max-width:150px}.score-details{grid-template-columns:repeat(4,1fr)}.sentence-info{text-align:left;justify-content:flex-start}.translation-text{margin-top:0;margin-left:5px}.file-upload-header{flex-wrap:nowrap}.header-left{max-width:calc(100% - 200px)}.tool-description{max-width:100%}}
@media (min-width:992px){h1{font-size:2rem;max-width:100%}.mode-container{min-width:250px}h1{font-size:clamp(1.8rem,3vw,2rem);white-space:normal;overflow:visible;line-height:1.2}}
.header-grid{display:grid;grid-template-columns:1fr auto;grid-template-areas:"left right";gap:15px;margin-bottom:20px;align-items:center}
.header-left{grid-area:left;display:flex;flex-direction:column;gap:8px}
.header-right{grid-area:right;display:flex;flex-direction:column;align-items:flex-end;gap:8px}
.stats-section{background:rgba(255,255,255,0.92);border-radius:12px;padding:16px;margin-top:16px;box-shadow:0 5px 15px rgba(0,0,0,0.15)}
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.stats-item{background:rgba(255,255,255,0.7);padding:10px;border-radius:8px;text-align:center;font-weight:bold;color:#1a2a6c}
.stats-value{display:block;margin-top:5px;font-size:1.15rem}
.corpus-section-compressed{background:rgba(255,255,255,0.92);border-radius:12px;padding:12px;margin-top:16px;box-shadow:0 5px 15px rgba(0,0,0,0.15)}
.corpus-title-inline{font-size:1.5rem;color:#1a2a6c;font-weight:bold;margin-bottom:8px;text-align:left}
.file-upload-container{display:flex;flex-direction:column;gap:8px}
.file-upload-row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.file-upload-btn{background:#1a2a6c;color:#fff;border:none;border-radius:8px;padding:8px 14px;font-weight:bold;cursor:pointer}
.file-name{color:#333;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60%}
.upload-status{font-size:0.95rem;color:#555}
.main-content{display:grid;grid-template-columns:2fr 1fr;gap:20px}
@media (max-width:991px){.main-content{grid-template-columns:1fr}}
.left-column{display:flex;flex-direction:column;gap:16px;min-height:100%}
.stats-section{background:rgba(255,255,255,0.92);border-radius:12px;padding:16px;box-shadow:0 5px 15px rgba(0,0,0,0.15)}
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.stats-item{background:rgba(255,255,255,0.7);padding:10px;border-radius:8px;text-align:center;font-weight:bold;color:#1a2a6c}
.stats-value{display:block;margin-top:5px;font-size:1.1rem}
.corpus-management-section{background:#f8f9fa;border-radius:8px;padding:16px;margin-top:16px;border:1px solid #ddd;box-shadow:0 2px 5px rgba(0,0,0,0.05)}
.corpus-header{font-size:1.2rem;color:#1a2a6c;font-weight:bold;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid #ddd}
.upload-row{display:flex;flex-wrap:wrap;align-items:center;gap:12px}
.upload-controls{display:flex;align-items:center;gap:12px;flex:1;min-width:200px}
.upload-status-container{flex:1;min-width:50%;text-align:right}
.corpus-hint{font-size:0.85rem;color:#666;flex:1;min-width:100%;padding:8px;background:rgba(255,255,255,0.7);border-radius:6px;text-align:center;width:297.5px;display:flex;align-items:center;justify-content:center}
@media (min-width:768px){.upload-row{flex-wrap:nowrap;align-items:center}.upload-controls{flex:2}.upload-status-container{flex:0 0 auto;min-width:0;align-self:stretch;display:flex;align-items:center;justify-content:flex-end}.corpus-hint{min-width:0;flex:0 0 auto;text-align:right;align-self:stretch;display:flex;align-items:center;justify-content:center;margin-left:auto;padding-right:0}.upload-status{margin-top:0;width:auto;text-align:right}}
.puzzle-container.simple-mode .puzzle-slot{min-width:104px!important;max-width:138px!important;flex:0 0 calc(33.333% - 15px)!important}
@media (max-width:767px){.puzzle-container.simple-mode .puzzle-slot{min-width:104px!important;max-width:138px!important}}
.puzzle-slot:empty::after{content:"↓ 放置位置";color:#999;font-size:0.7rem;font-style:italic;position:absolute;top:50%;left:0;right:0;transform:translateY(-50%);text-align:center}
.empty-state{text-align:center;padding:16px;background:rgba(255,255,255,0.8);border-radius:8px;margin:10px 0;display:none}
.empty-state.show{display:block}
.empty-state p{margin-bottom:10px;font-weight:bold;color:#1a2a6c}
.guide-animation{font-size:2rem;animation:bounce 1.5s infinite}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.loading-spinner{display:inline-block;width:16px;height:16px;border:3px solid rgba(255,255,255,0.3);border-radius:50%;border-top-color:white;animation:spin 1s ease-in-out infinite;margin-right:8px}
.initial-hint{text-align:center;padding:20px;color:#666;font-style:italic}

/* Mobile-specific refinements for better fit and alignment */
@media (max-width:767px){
  .advanced-tip{top:56px;font-size:0.85rem;padding:6px 12px}
  .puzzle-container{gap:8px}
  .puzzle-slot{min-width:92px;max-width:128px;height:46px}
  .puzzle-slot.punctuation-slot{min-width:80px;max-width:110px}
  .puzzle-slot::before{top:-20px;font-size:0.72rem;padding:2px 6px}
  .puzzle-piece{min-width:64px;min-height:36px;height:auto;font-size:0.9rem;white-space:normal;word-break:break-word;overflow-wrap:anywhere;line-height:1.2;padding:6px 10px}
  .puzzle-slot>.puzzle-piece{white-space:normal}
  .translation-text{font-size:0.95rem}
}
</style>
</head>
<body style="height:100%">
<div class="container">
<div class="advanced-tip" id="advancedTip">提示：进阶模式下有部分拼图不需要</div>
<header class="header-grid">
  <div class="header-left">
    <h1>至元德语 - 造句练习器 A1-1</h1>
    <p class="tool-description">完成拼图，掌握四大句型和动词第二位规律</p>
  </div>
  <div class="header-right">
    <div class="mode-title">句型和动词的位置练习</div>
    <div class="mode-selector">
      <div class="mode-btn active" id="simpleModeBtn">简单模式</div>
      <div class="mode-btn" id="advancedModeBtn">进阶模式</div>
    </div>
  </div>
</header>

<div class="main-content">
  <div class="left-column">
    <section class="exercise-section">
      <div class="sentence-puzzle-header">
        <h2 class="section-title">句型拼图练习</h2>
        <div aria-hidden="true" class="reading-indicator" id="readingIndicator">
          <div class="reading-dot dot1"></div>
          <div class="reading-dot dot2"></div>
          <div class="reading-dot dot3"></div>
        </div>
      </div>
      <div class="sentence-info">
        中文：<span class="translation-text" id="currentTranslation">请上传语料库开始练习</span>
      </div>
      
      <div class="empty-state" id="emptyState">
        <p>请从下方词汇区拖拽单词到句子框架中</p>
        <div class="guide-animation">↓</div>
      </div>
      
      <div class="puzzle-container-wrapper">
        <div class="puzzle-container" id="puzzleContainer">
          <div class="puzzle-slot" data-label="第1位" id="slot1"></div>
          <div class="puzzle-slot" data-label="第2位" id="slot2"></div>
          <div class="puzzle-slot" data-label="其他位" id="slot3"></div>
          <div class="puzzle-slot punctuation-slot" data-label="标点" id="slot4"></div>
        </div>
      </div>
      
      <div class="word-bank" id="wordBank"></div>
      <div class="controls">
        <button class="btn btn-secondary" id="resetBtn">重置拼图</button>
        <button class="btn btn-submit" id="submitBtn">提交答案 <span class="btn-icon">💡</span></button>
        <button class="btn btn-success" id="nextBtn">下一题</button>
        <div class="next-button-warning" id="nextButtonWarning">请先提交答案，再进行下一题！</div>
      </div>
      <div class="feedback" id="feedback">
        <div class="feedback-header">
          <h3 class="feedback-title">评价及解析</h3>
          <div class="current-score-container" id="currentScoreContainer">
            得分：<span id="currentScore">0</span> / <span id="maxScore">5</span>
          </div>
        </div>
        <div class="reference-answer">参考答案: <span id="referenceAnswer"></span></div>
        <div class="score-details">
          <div class="score-item"><div>第1位</div><div class="score-value" id="slot1Score">0</div></div>
          <div class="score-item"><div>第2位</div><div class="score-value" id="slot2Score">0</div></div>
          <div class="score-item"><div>其他位</div><div class="score-value" id="slot3Score">0</div></div>
          <div class="score-item"><div>标点</div><div class="score-value" id="slot4Score">0</div></div>
        </div>
        <div class="initial-hint" id="initialHint">完成练习后，显示答案解析和得分</div>
      </div>
    </section>
    <section class="stats-section">
      <div class="stats-grid">
        <div class="stats-item">完成题数<span class="stats-value" id="totalCompleted">0</span></div>
        <div class="stats-item">正确率<span class="stats-value" id="accuracy">0%</span></div>
        <div class="stats-item">高频错误<span class="stats-value" id="topErrors">-</span></div>
        <div class="stats-item">剩余答题数<span class="stats-value" id="remainingQuestions">0</span></div>
      </div>
    </section>
  </div>
  
  <section class="theory-section">
    <h2 class="section-title">练习要点</h2>
    <div style="margin-top:10px;">
      <h3 style="color:#1a2a6c;">练习词汇表</h3>
      <div id="vocabContainer">
        <!-- 动态生成词汇表 -->
      </div>
    </div>
    <div style="margin-top:16px;">
      <h3 style="color:#1a2a6c;">语法小贴士</h3>
      <div class="theory-card">
        <ul>
          <li>第1位先确定句型，再选择内容</li>
          <li>四大句型和第1位的关系:
            <ul>
              <li>陈述句的第1位通常是主语或其他</li>
              <li>W-疑问句第1位是W-疑问词</li>
              <li>命令句和Ja/Nein疑问句第1位空缺</li>
            </ul>
          </li>
          <li>始终注意动词的位置 - 必须在第二位</li>
        </ul>
      </div>
    </div>
  </section>
</div>

<!-- 语料库管理区域 -->
<section class="corpus-management-section">
  <div class="corpus-header">语料库管理</div>
  <div class="upload-row">
    <div class="upload-controls">
      <button class="file-upload-btn" id="uploadBtn">
        <svg fill="none" height="20" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="20">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="17 8 12 3 7 8"></polyline>
          <line x1="12" x2="12" y1="3" y2="15"></line>
        </svg>
        上传本地语料
      </button>
      <button class="file-upload-btn" id="fetchJsonBtn" style="background:#2a6c1a;">
        <svg fill="white" height="20" viewBox="0 0 24 24" width="20">
          <path d="M12 21c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm6-7h-1.7c0 3-2.5 5.1-5.3 5.1S6.7 17 6.7 14H5c0 3.4 2.7 6.2 6 6.7V23h2v-2.3c3.3-.5 6-3.3 6-6.7zm-9-9.9V1h2v3.1c3.4.5 6 3.3 6 6.7h-1.7c0-3-2.5-5.1-5.3-5.1S6.7 7 6.7 10H5c0-3.4 2.7-6.2 6-6.7z"/>
        </svg>
        获取云端语料
      </button>
      <input type="file" id="corpusFile" accept=".json" style="display:none;">
      <span class="file-name" id="fileName">未选择文件</span>
    </div>
    
    <div class="upload-status-container">
      <div class="upload-status" id="uploadStatus"></div>
    </div>
    
    <!-- 授权提示 -->
    <div class="corpus-hint">
      请本地上传或云端加载语料库json
    </div>
  </div>
</section>

<div class="copyright">© 2025 至元德语原创开发，仅供内部学生使用，未经书面许可禁止复制、传播或商用。</div>
<script>
const AppConfig={REMOTE_URL:"https://zydeutsch-chen.github.io/ZYDetusch-model/A1-1sentences-encrypted.json",exerciseType:'A1-1',slots:{labels:['第1位','第2位','其他位','标点'],scoring:{simple:{slot1:2,slot2:2,slot3:1},advanced:{slot1:1.5,slot2:2,slot3:1,slot4:0.5}}},vocabCategories:[{id:'questionWords',name:'疑问词',color:'#ffcc80'},{id:'verbs',name:'动词',color:'#a5d6a7'},{id:'subjects',name:'主语',color:'#90caf9'},{id:'others',name:'其他',color:'#f48fb1'}],uiStrings:{chinese:{uploadHint:'请选择本地上传或云端加载语料库json',emptyStateText:'请从下方词汇区拖拽单词到句子框架中',nextButtonWarning:'请先提交答案，再进行下一题！',advancedTip:'提示：进阶模式下有部分拼图不需要'}}};

const Decryptor={decryptCorpusIfNeeded(payload){try{if(typeof payload==='object')return payload;const trimmedPayload=payload.trim();if(trimmedPayload.startsWith('{')||trimmedPayload.startsWith('['))return JSON.parse(trimmedPayload);const keySuffix="et";let processedPayload=trimmedPayload;if(processedPayload.endsWith(keySuffix))processedPayload=processedPayload.slice(0,-keySuffix.length);let base64Str=processedPayload.replace(/^data:[^;]+;base64,/,'').replace(/[\s\n]/g,'').replace(/-/g,'+').replace(/_/g,'/');const pad=base64Str.length%4;if(pad)base64Str+='='.repeat(4-pad);const binaryString=atob(base64Str);const bytes=new Uint8Array(binaryString.length);for(let i=0;i<binaryString.length;i++)bytes[i]=binaryString.charCodeAt(i);const plainBytes=this.xorWithKey(bytes,"ZY-secret");const jsonStr=new TextDecoder().decode(plainBytes);return JSON.parse(jsonStr)}catch(error){console.error('解密失败:',error);throw new Error(`解密失败: ${error.message}`)}},xorWithKey(bytes,key){const keyBytes=new TextEncoder().encode(key);const result=new Uint8Array(bytes.length);for(let i=0;i<bytes.length;i++)result[i]=bytes[i]^keyBytes[i%keyBytes.length];return result}};

const RemoteLoader={async loadRemoteCorpus(){const statusElement=document.getElementById('uploadStatus');const fetchBtn=document.getElementById('fetchJsonBtn');const originalBtnText=fetchBtn.innerHTML;const urls=["https://zydeutsch-chen.github.io/ZYDetusch-model/A1-1sentences-encrypted.json","https://raw.githubusercontent.com/zydeutsch-chen/ZYDetusch-model/main/A1-1sentences-encrypted.json"];try{statusElement.textContent='正在连接服务器...';statusElement.className='upload-status';statusElement.style.display='block';fetchBtn.disabled=true;fetchBtn.innerHTML='<div class="loading-spinner"></div>获取中...';let response,encryptedText;for(let i=0;i<urls.length;i++){try{statusElement.textContent=`正在尝试连接服务器 ${i+1}/${urls.length}...`;response=await fetch(urls[i],{method:'GET',mode:'cors',headers:{'Accept':'application/json'}});if(response.ok){encryptedText=await response.text();break}}catch(e){console.warn(`URL ${i+1} 失败:`,e);if(i===urls.length-1)throw new Error(`所有服务器连接失败: ${e.message}`)}}if(!response||!response.ok)throw new Error(`网络错误: ${response?.status} ${response?.statusText}`);statusElement.textContent='正在解密数据...';const corpusData=Decryptor.decryptCorpusIfNeeded(encryptedText);if(!corpusData.sentences||!Array.isArray(corpusData.sentences))throw new Error("无效的语料库格式: 缺少句子数据");if(!corpusData.vocabulary||typeof corpusData.vocabulary!=='object')throw new Error("无效的语料库格式: 缺少词汇表数据");statusElement.textContent='语料库加载成功！';statusElement.className='upload-status success';return corpusData}catch(error){console.error('加载远程语料库失败:',error);let errorMsg=error.message;if(errorMsg.includes('NetworkError')||errorMsg.includes('Failed to fetch'))errorMsg='网络连接失败，请检查网络连接或稍后重试';else if(errorMsg.includes('CORS'))errorMsg='跨域访问被阻止，请使用本地文件上传';statusElement.textContent=`错误: ${errorMsg}`;statusElement.className='upload-status error';throw error}finally{fetchBtn.innerHTML=originalBtnText;fetchBtn.disabled=false}}};

const Model=(()=>{let sentences=[];let vocabulary={questionWords:new Set(),verbs:new Set(),subjects:new Set(),others:new Set(),punctuation:new Set([".","?"])};let statistics={totalCompleted:0,perfectCount:0,errorCounts:{slot1:0,slot2:0,slot3:0},answeredCount:0,totalErrors:0,totalQuestions:0};let usedIndices=new Set();const loadCorpus=(data)=>{if(!data.sentences||!Array.isArray(data.sentences))throw new Error('无效的语料库格式: 缺少句子数据');sentences=data.sentences.map(s=>{const parts={...s.parts};Object.keys(parts).forEach(key=>{if(parts[key]==="空缺")parts[key]=""});return{...s,parts}});vocabulary.questionWords=new Set(data.vocabulary?.questionWords||[]);vocabulary.verbs=new Set(data.vocabulary?.verbs||[]);vocabulary.subjects=new Set(data.vocabulary?.subjects||[]);vocabulary.others=new Set(data.vocabulary?.others||[]);vocabulary.punctuation=new Set(data.vocabulary?.punctuation||[".","?"]);usedIndices=new Set();statistics.totalQuestions=sentences.length;return true};const getRandomSentence=()=>{if(sentences.length===0)return{parts:{slot1:"",slot2:"",slot3:"",slot4:""},full:"请上传语料库",translation:"请上传语料库开始练习",weight:1};if(usedIndices.size>=50||usedIndices.size===sentences.length)return{parts:{slot1:"",slot2:"",slot3:"",slot4:""},full:"恭喜你，你已完成所有练习！",translation:"恭喜你，你已完成所有练习！",weight:1,isCompleted:true};const availableIndices=[];sentences.forEach((sentence,index)=>{if(!usedIndices.has(index))availableIndices.push(index)});const totalWeight=availableIndices.reduce((sum,index)=>sum+sentences[index].weight,0);let random=Math.random()*totalWeight;for(const index of availableIndices){random-=sentences[index].weight;if(random<=0){usedIndices.add(index);return sentences[index]}}return sentences[availableIndices[0]]};const updateStatistics=(scoreResult,isAdvancedMode)=>{statistics.totalCompleted+=1;statistics.answeredCount+=1;if(scoreResult.total<5)statistics.totalErrors+=1;if(scoreResult.total===5)statistics.perfectCount+=1;const{scores}=scoreResult;if(scores.slot1<(isAdvancedMode?1.5:2))statistics.errorCounts.slot1+=1;if(scores.slot2<2)statistics.errorCounts.slot2+=1;if(scores.slot3<(isAdvancedMode?1:1))statistics.errorCounts.slot3+=1};const getStatistics=()=>statistics;const getVocabulary=()=>vocabulary;return{sentences,vocabulary,statistics,loadCorpus,getRandomSentence,updateStatistics,getStatistics,getVocabulary}})();

const Speech=(()=>{let userInteracted=false;let isSpeaking=false;let chineseVoice=null;let germanVoice=null;let voicesReady=false;let lastSpokenTranslation="";const initSpeech=()=>{if(!userInteracted)return;if(!voicesReady){const voices=window.speechSynthesis.getVoices();if(voices.length===0){window.speechSynthesis.onvoiceschanged=()=>{voicesReady=true;initSpeech()};return}voicesReady=true}const voices=window.speechSynthesis.getVoices();chineseVoice=voices.find(v=>v.lang.includes('zh')&&v.name.toLowerCase().includes('female'))||voices.find(v=>v.lang.includes('zh'));germanVoice=voices.find(v=>(v.lang==='de-DE'||v.lang==='de-CH'||v.lang==='de')&&v.name.toLowerCase().includes('male'))||voices.find(v=>v.lang.includes('de'))};const speakChinese=(text)=>{if(!userInteracted)return;if(lastSpokenTranslation===text)return;if(!chineseVoice){initSpeech();if(!chineseVoice){console.log("没有找到中文语音");return}}if(isSpeaking)window.speechSynthesis.cancel();const utterance=new SpeechSynthesisUtterance(text);if(chineseVoice){utterance.voice=chineseVoice;utterance.lang=chineseVoice.lang||'zh-CN'}else{utterance.lang='zh-CN'}utterance.rate=0.9;const indicator=document.getElementById('readingIndicator');indicator&&indicator.classList.add('speaking');isSpeaking=true;utterance.onend=()=>{indicator&&indicator.classList.remove('speaking');isSpeaking=false;lastSpokenTranslation=text};window.speechSynthesis.speak(utterance)};const speakGerman=(text)=>{if(!userInteracted)return;if(!germanVoice){initSpeech();if(!germanVoice){console.log("没有找到德语语音");return}}if(isSpeaking)window.speechSynthesis.cancel();const utterance=new SpeechSynthesisUtterance(text);if(germanVoice){utterance.voice=germanVoice;utterance.lang=germanVoice.lang||'de-DE'}else{utterance.lang='de-DE'}utterance.rate=0.9;const indicator=document.getElementById('readingIndicator');indicator&&indicator.classList.add('speaking');isSpeaking=true;utterance.onend=()=>{indicator&&indicator.classList.remove('speaking');isSpeaking=false};window.speechSynthesis.speak(utterance)};document.addEventListener('click',()=>{if(!userInteracted){userInteracted=true;initSpeech()}});return{speakChinese,speakGerman}})();

const Algorithm=(()=>{const getAllVocabulary=()=>{const allWords=new Set();Model.vocabulary.questionWords.forEach(word=>allWords.add(word));Model.vocabulary.verbs.forEach(word=>allWords.add(word));Model.vocabulary.subjects.forEach(word=>allWords.add(word));Model.vocabulary.others.forEach(word=>allWords.add(word));Model.vocabulary.punctuation.forEach(word=>allWords.add(word));return allWords};const getDistractorWords=(sentence)=>{const distractorWords=getAllVocabulary();Object.values(sentence.parts).forEach(part=>{distractorWords.delete(part)});distractorWords.delete(".");distractorWords.delete("?");distractorWords.delete("");return Array.from(distractorWords)};const calculateScore=(userAnswers,correctAnswers,isAdvancedMode)=>{const scores={slot1:0,slot2:0,slot3:0,slot4:0};if(userAnswers.slot1===correctAnswers.slot1)scores.slot1=isAdvancedMode?AppConfig.slots.scoring.advanced.slot1:AppConfig.slots.scoring.simple.slot1;if(userAnswers.slot2===correctAnswers.slot2)scores.slot2=isAdvancedMode?AppConfig.slots.scoring.advanced.slot2:AppConfig.slots.scoring.simple.slot2;if(isAdvancedMode){if(userAnswers.slot3===correctAnswers.slot3)scores.slot3=AppConfig.slots.scoring.advanced.slot3;if(userAnswers.slot4===correctAnswers.slot4)scores.slot4=AppConfig.slots.scoring.advanced.slot4}else{const expectedSlot3=correctAnswers.slot3+correctAnswers.slot4;if(userAnswers.slot3===expectedSlot3)scores.slot3=AppConfig.slots.scoring.simple.slot3}const total=Object.values(scores).reduce((sum,score)=>sum+score,0);return{scores,total:Math.round(total*10)/10}};return{getDistractorWords,calculateScore}})();

const MobileClick=(()=>{const isMobile=()=>/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);let isClickEnabled=false;const initClickSelection=()=>{if(!isMobile())return;isClickEnabled=true;const bank=document.getElementById('wordBank');const pc=document.getElementById('puzzleContainer');if(!bank||!pc)return;bank.addEventListener('click',handleWordClick,{passive:true});pc.addEventListener('click',handleSlotClick,{passive:true});
  // 使用已有的 advanced-tip 样式，显示紧凑提示
  const tipEl=document.getElementById('advancedTip');
  if(tipEl){
    tipEl.textContent='提示：点击下方拼图依次填入上方；点击已放置可撤回';
    tipEl.classList.add('show');
    setTimeout(()=>tipEl.classList.remove('show'),2500);
  }
};const handleWordClick=e=>{if(!isClickEnabled)return;const wordElement=e.target.closest('.puzzle-piece');if(!wordElement||!wordElement.parentElement||wordElement.parentElement.id!=='wordBank')return;const slots=[document.getElementById('slot1'),document.getElementById('slot2'),document.getElementById('slot3'),document.getElementById('slot4')];const emptySlot=slots.find(slot=>!slot.firstChild);if(!emptySlot)return;moveWordToSlot(wordElement,emptySlot)};const handleSlotClick=e=>{if(!isClickEnabled)return;const slot=e.target.closest('.puzzle-slot');if(!slot||!slot.firstChild)return;removeWordFromSlot(slot)};const moveWordToSlot=(wordElement,slot)=>{const clone=wordElement.cloneNode(true);if(window.UI?.isAdvancedMode&&slot.id===window.UI?.currentFirstInitialSlot&&clone.textContent)clone.textContent=clone.textContent.charAt(0).toUpperCase()+clone.textContent.slice(1);slot.appendChild(clone);slot.classList.add('filled');wordElement.remove()};const removeWordFromSlot=slot=>{const wordElement=slot.firstChild;let originalText=wordElement.textContent;if(window.UI?.isAdvancedMode&&slot.id===window.UI?.currentFirstInitialSlot&&originalText)originalText=originalText.charAt(0).toLowerCase()+originalText.slice(1);wordElement.textContent=originalText;const bank=document.getElementById('wordBank');if(bank)bank.appendChild(wordElement);slot.classList.remove('filled')};return{initClickSelection}})();

/* 用户界面模块 */
const UI = (() => {
  // DOM元素
  const elements = {
    slot1: document.getElementById("slot1"),
    slot2: document.getElementById("slot2"),
    slot3: document.getElementById("slot3"),
    slot4: document.getElementById("slot4"),
    wordBank: document.getElementById("wordBank"),
    feedback: document.getElementById("feedback"),
    referenceAnswer: document.getElementById("referenceAnswer"),
    currentTranslation: document.getElementById("currentTranslation"),
    slot1Score: document.getElementById("slot1Score"),
    slot2Score: document.getElementById("slot2Score"),
    slot3Score: document.getElementById("slot3Score"),
    slot4Score: document.getElementById("slot4Score"),
    currentScore: document.getElementById("currentScore"),
    maxScore: document.getElementById("maxScore"),
    currentScoreContainer: document.getElementById("currentScoreContainer"),
    simpleModeBtn: document.getElementById("simpleModeBtn"),
    advancedModeBtn: document.getElementById("advancedModeBtn"),
    resetBtn: document.getElementById("resetBtn"),
    submitBtn: document.getElementById("submitBtn"),
    nextBtn: document.getElementById("nextBtn"),
    advancedTip: document.getElementById("advancedTip"),
    nextButtonWarning: document.getElementById("nextButtonWarning"),
    readingIndicator: document.getElementById("readingIndicator"),
    uploadBtn: document.getElementById("uploadBtn"),
    corpusFile: document.getElementById("corpusFile"),
    fileName: document.getElementById("fileName"),
    uploadStatus: document.getElementById("uploadStatus"),
    totalCompleted: document.getElementById("totalCompleted"),
    accuracy: document.getElementById("accuracy"),
    topErrors: document.getElementById("topErrors"),
    remainingQuestions: document.getElementById("remainingQuestions"),
    puzzleContainer: document.getElementById("puzzleContainer"),
    vocabContainer: document.getElementById("vocabContainer"),
    emptyState: document.getElementById("emptyState"),
    fetchJsonBtn: document.getElementById("fetchJsonBtn"),
    initialHint: document.getElementById("initialHint")
  }; 
  
  // 状态变量
  let isAdvancedMode = false;
  let isSubmitted = false;
  let nextButtonWarningShown = false;
  let consecutiveNextClicks = 0;
  let currentSentence = null;
  let draggedElement = null;
  let currentFirstInitialSlot = 'slot1';
  let hasFilledAllSlots = false;

  // 初始化拖放功能
  const initDragAndDrop = () => {
    const slots = [elements.slot1, elements.slot2, elements.slot3, elements.slot4];
    
    // 为槽位添加触摸事件
    slots.forEach(slot => {
      slot.addEventListener('touchmove', function(e) {
        e.preventDefault();
      });
      
      slot.addEventListener('touchend', function(e) {
        if (!draggedElement) return;
        
        e.preventDefault();
        
        if (this.firstChild) {
          const existingPiece = this.firstChild;
          elements.wordBank.appendChild(existingPiece);
        }
        
        this.innerHTML = "";
        const clone = draggedElement.cloneNode(true);
        
        // 进阶模式且是slot1位置：首字母大写
        if (isAdvancedMode && this.id === currentFirstInitialSlot && clone.textContent) {
          clone.textContent = clone.textContent.charAt(0).toUpperCase() + clone.textContent.slice(1);
        }
        
        this.appendChild(clone);
        this.classList.add('filled');
        
        draggedElement.remove();
        draggedElement = null;
      });
    });
    
    // 为槽位添加鼠标事件
    slots.forEach(slot => {
      slot.ondragover = e => e.preventDefault();
      
      slot.ondrop = e => {
        e.preventDefault();
        let data;
        try {
          data = JSON.parse(e.dataTransfer.getData("application/json"));
        } catch (error) {
          console.error("解析拖拽数据失败:", error);
          return;
        }
        
        if (slot.firstChild) {
          const existingPiece = slot.firstChild;
          elements.wordBank.appendChild(existingPiece);
        }
        
        slot.innerHTML = "";
        const el = document.createElement("div");
        el.className = "puzzle-piece";
        
        if (data.text === "." || data.text === "?") {
          el.classList.add("punctuation");
        }
        
        // 空字符串添加特殊样式
        if (data.text === "") {
          el.classList.add("empty-slot");
        }
        
        // 进阶模式且是slot1位置：首字母大写
        let displayText = data.text;
        if (isAdvancedMode && slot.id === currentFirstInitialSlot && displayText) {
          displayText = displayText.charAt(0).toUpperCase() + displayText.slice(1);
        }
        
        el.textContent = displayText;
        el.draggable = true;
        el.dataset.correctSlot = data.correctSlot;
        slot.appendChild(el);
        slot.classList.add('filled');
        
        // 移除单词库中的相同单词（使用原始文本匹配，避免大小写问题）
        const wordBankPieces = [...elements.wordBank.children];
        for (let i = 0; i < wordBankPieces.length; i++) {
          const originalText = data.text;
          const pieceText = wordBankPieces[i].textContent;
          // 比较时忽略大小写差异
          if (pieceText.toLowerCase() === originalText.toLowerCase()) {
            wordBankPieces[i].remove();
            break;
          }
        }
      };
    });
  };

  // 显示高级提示
  const showAdvancedTip = () => {
    elements.advancedTip.textContent = AppConfig.uiStrings.chinese.advancedTip;
    elements.advancedTip.classList.add("show");
    setTimeout(() => {
      elements.advancedTip.classList.remove("show");
    }, 3000);
  };

  // 统一提示容器
  const showWarn = (msg) => {
    elements.nextButtonWarning.textContent = msg;
    elements.nextButtonWarning.classList.add("show");
    setTimeout(() => elements.nextButtonWarning.classList.remove("show"), 2000);
  };

  // 动态生成词汇表
  const populateVocabulary = () => {
    elements.vocabContainer.innerHTML = '';
    const vocab = Model.getVocabulary();
    
    AppConfig.vocabCategories.forEach(category => {
      const words = vocab[category.id];
      if (!words || words.size === 0) return;
      
      const section = document.createElement('div');
      section.className = 'vocab-block';
      section.style.backgroundColor = category.color;
      section.style.padding = '10px';
      section.style.borderRadius = '8px';
      section.style.marginBottom = '12px';
      
      const title = document.createElement('strong');
      title.textContent = category.name;
      section.appendChild(title);
      
      const container = document.createElement('div');
      container.className = 'vocab-container';
      
      words.forEach(word => {
        if (word === "") return; // 跳过空字符串
        
        const item = document.createElement('span');
        item.className = 'vocab-item';
        item.textContent = word;
        container.appendChild(item);
      });
      
      section.appendChild(container);
      elements.vocabContainer.appendChild(section);
    });
  };

  // 更新统计显示
  const updateStatisticsDisplay = () => {
    const stats = Model.statistics;
    elements.totalCompleted.textContent = stats.totalCompleted;
    const accuracy = stats.totalCompleted > 0 ? (stats.perfectCount / stats.totalCompleted * 100).toFixed(0) : 0;
    elements.accuracy.textContent = `${accuracy}%`;
    
    // 高频错误：只有错误题数 >= 3 时才显示
    if (stats.totalErrors >= 3) {
      const errorCounts = stats.errorCounts;
      let errorsArray = Object.entries(errorCounts)
        .sort((a, b) => {
          if (b[1] !== a[1]) {
            return b[1] - a[1];
          }
          const priority = { 'slot1': 1, 'slot2': 2, 'slot3': 3 };
          return priority[a[0]] - priority[b[0]];
        });
      errorsArray = errorsArray.slice(0, 2);
      const errorNames = errorsArray.map(item => {
        if (item[0] === 'slot1') return '1位';
        if (item[0] === 'slot2') return '2位';
        if (item[0] === 'slot3') return '其他位';
        return '';
      });
      elements.topErrors.textContent = errorNames.join(' ') || '无';
    } else {
      elements.topErrors.textContent = "-";
    }
    
    elements.remainingQuestions.textContent = Math.max(0, (Model.sentences?.length || 50) - stats.answeredCount);
  };

  // 加载句子到UI
  const loadSentence = (sentence) => {
    [elements.slot1, elements.slot2, elements.slot3, elements.slot4].forEach(s => { s.innerHTML = ""; s.classList.remove('filled'); });
    elements.wordBank.innerHTML = "";
    
    currentSentence = sentence;
    
    // 检查是否已完成所有练习
    if (sentence.isCompleted) {
      elements.currentTranslation.textContent = sentence.translation;
      elements.wordBank.innerHTML = '<div class="puzzle-piece" style="background:#4CAF50;color:white;">练习已完成</div>';
      elements.nextBtn.disabled = true;
      elements.submitBtn.disabled = true;
      return;
    } else {
      elements.nextBtn.disabled = false;
      elements.submitBtn.disabled = false;
    }
    
    // 创建拼图块
    let pieces = [];
    
    if (isAdvancedMode) {
      // 直接使用空字符串
      pieces.push(
        {text: sentence.parts.slot1, correctSlot: "slot1"},
        {text: sentence.parts.slot2, correctSlot: "slot2"},
        {text: sentence.parts.slot3, correctSlot: "slot3"}
      );
      
      // 标点符号处理
      const puncts = [".", "?"];
      const correctPunct = sentence.parts.slot4;
      const wrongPunct = puncts.find(p => p !== correctPunct);
      
      pieces.push(
        {text: correctPunct, correctSlot: "slot4"},
        {text: wrongPunct, correctSlot: "none"}
      );
      
      // 添加干扰词（排除空字符串）
      const distractors = Algorithm.getDistractorWords(sentence);
      if (distractors.length > 0) {
        const randomDistractor = distractors[Math.floor(Math.random() * distractors.length)];
        pieces.push({text: randomDistractor, correctSlot: "none"});
      }
    
      // 如果答案三槽都不是空字符串，添加一个空白干扰块
      const hasEmptyInAnswer = [sentence.parts.slot1, sentence.parts.slot2, sentence.parts.slot3].some(x => x === "");
      const hasEmptyPiece = pieces.some(p => p.text === "");
      if (!hasEmptyInAnswer && !hasEmptyPiece) {
        pieces.push({text: "", correctSlot: "none"});
      }

      // 记录句子的第一个非空槽位，用于显示时隐藏句首大写线索
      var firstInitialSlot = sentence.parts.slot1 !== "" ? "slot1" : (sentence.parts.slot2 !== "" ? "slot2" : "slot3");
      var firstInitialText = sentence.parts[firstInitialSlot] || "";
      currentFirstInitialSlot = firstInitialSlot;
      // 同步到全局，供移动点击模块使用
      if(window.UI){ window.UI.currentFirstInitialSlot = currentFirstInitialSlot; }

    } else {
      // 简单模式下的拼图块 - 修复空字符串处理
      pieces = [
        {text: sentence.parts.slot1 || "", correctSlot: "slot1"},
        {text: sentence.parts.slot2 || "", correctSlot: "slot2"},
        {text: (sentence.parts.slot3 || "") + (sentence.parts.slot4 || ""), correctSlot: "slot3"}
      ];
    }
    
    // 随机排序并添加到UI
    pieces.sort(() => Math.random() - 0.5);
    
    pieces.forEach(p => {
      const el = document.createElement("div");
      el.className = "puzzle-piece";
      
      if (p.text === "." || p.text === "?") {
        el.classList.add("punctuation");
      }
      
      // 空字符串与普通块一致显示（不添加特殊样式）
      // if (p.text === "") { /* no special class */ }
      
      // 进阶模式：隐藏句首大写线索（仅在句首为疑问词/动词/人称代词/冠词mein时）
      let displayText = p.text;
      if (isAdvancedMode && typeof currentFirstInitialSlot !== "undefined" && p.correctSlot === currentFirstInitialSlot && displayText) {
        const m = displayText.match(/^([A-Za-zÄÖÜäöüß]+)/u);
        const firstWord = m ? m[1] : "";
        const isFirstUpper = /^[A-ZÄÖÜ]/.test(firstWord);
        const lw = firstWord.toLowerCase();
        const pronouns = new Set(["ich","du","er","sie","es","wir","ihr"]); // 不含"Sie"以避免误改
        const isQ = !!(Model.vocabulary?.questionWords && Model.vocabulary.questionWords.has(lw));
        const isV = !!(Model.vocabulary?.verbs && Model.vocabulary.verbs.has(lw));
        // 保留专有名/名词的大写：若原本首字母大写，且既不是疑问词也不是动词也不是常见人称代词/"mein"，则不降级
        let isCommonLowerCategory = isQ || isV || pronouns.has(lw) || lw === 'mein';
        let shouldLower = !isFirstUpper || isCommonLowerCategory;
        if (firstWord === 'Sie') { shouldLower = false; }
        if (shouldLower) {
          displayText = displayText.replace(/^(\p{L})/u, ch => ch.toLowerCase());
        }
      }
      el.textContent = displayText;
      el.draggable = true;
      el.dataset.correctSlot = p.correctSlot;
      elements.wordBank.appendChild(el);
      
      // 为拼图块添加事件
      addTouchEvents(el, p);
      addMouseEvents(el, p);
    });
    
    // 更新UI内容
    elements.referenceAnswer.textContent = sentence.full;
    elements.currentTranslation.textContent = sentence.translation;
    
    // 显示空状态引导
    if (pieces.length > 0) {
      elements.emptyState.classList.remove('show');
    } else {
      elements.emptyState.querySelector('p').textContent = AppConfig.uiStrings.chinese.emptyStateText;
      elements.emptyState.classList.add('show');
    }
    
    // 重置状态
    isSubmitted = false;
    nextButtonWarningShown = false;
    
    // 显示初始提示，隐藏得分详情
    elements.initialHint.style.display = 'block';
    document.querySelector('.score-details').style.display = 'none';
    document.querySelector('.reference-answer').style.display = 'none';
    document.querySelector('.feedback-header').style.display = 'none';
    
    // 朗读中文翻译
    setTimeout(() => {
      Speech.speakChinese(sentence.translation);
    }, 500);
    
    // 添加触摸事件处理函数
    function addTouchEvents(el, data) {
      el.addEventListener('touchstart', function(e) {
        e.preventDefault();
        draggedElement = el;
        this.classList.add('dragging');
      });
      
      el.addEventListener('touchend', function() {
        this.classList.remove('dragging');
        draggedElement = null;
      });
    }
    
    // 添加鼠标事件处理函数
    function addMouseEvents(el, data) {
      el.ondragstart = e => {
        try {
          e.dataTransfer.setData("application/json", JSON.stringify(data));
          e.dataTransfer.effectAllowed = "move";
        } catch(err) {
          console.warn('dragstart dataTransfer not supported', err);
        }
      };
    }
  };

  // 显示得分反馈
  const showScoreFeedback = (scoreResult) => {
    const { scores, total } = scoreResult;
    
    // 更新得分显示
    elements.slot1Score.textContent = scores.slot1;
    elements.slot2Score.textContent = scores.slot2;
    elements.slot3Score.textContent = scores.slot3;
    elements.slot4Score.textContent = isAdvancedMode ? scores.slot4 : "-";
    elements.currentScore.textContent = total;
    elements.maxScore.textContent = 5;
    
    // 设置得分颜色
    elements.currentScoreContainer.classList.remove("high", "low");
    if (total >= 4) {
      elements.currentScoreContainer.classList.add("high");
    } else {
      elements.currentScoreContainer.classList.add("low");
    }
    
    // 显示反馈区域
    elements.feedback.style.display = "block";
    
    // 显示得分详情，隐藏初始提示
    document.querySelector('.score-details').style.display = 'grid';
    document.querySelector('.reference-answer').style.display = 'block';
    document.querySelector('.feedback-header').style.display = 'flex';
    elements.initialHint.style.display = 'none';
    
    // 标记错误的位置
    document.querySelectorAll('.score-item').forEach(item => {
      item.classList.remove('error');
    });
    
    if (isAdvancedMode) {
      if (scores.slot1 < AppConfig.slots.scoring.advanced.slot1) 
        document.getElementById('slot1Score').parentNode.classList.add('error');
      if (scores.slot2 < AppConfig.slots.scoring.advanced.slot2) 
        document.getElementById('slot2Score').parentNode.classList.add('error');
      if (scores.slot3 < AppConfig.slots.scoring.advanced.slot3) 
        document.getElementById('slot3Score').parentNode.classList.add('error');
      if (scores.slot4 < AppConfig.slots.scoring.advanced.slot4) 
        document.getElementById('slot4Score').parentNode.classList.add('error');
    } else {
      if (scores.slot1 < AppConfig.slots.scoring.simple.slot1) 
        document.getElementById('slot1Score').parentNode.classList.add('error');
      if (scores.slot2 < AppConfig.slots.scoring.simple.slot2) 
        document.getElementById('slot2Score').parentNode.classList.add('error');
      if (scores.slot3 < AppConfig.slots.scoring.simple.slot3) 
        document.getElementById('slot3Score').parentNode.classList.add('error');
    }
    
    // 标记已提交
    isSubmitted = true;
    
    // 更新统计
    Model.updateStatistics(scoreResult, isAdvancedMode);
    updateStatisticsDisplay();
    
    // 如果满分，朗读德语句子
    if (total === 5) {
      Speech.speakGerman(currentSentence.full);
    }
  };

  // 刷新UI
  const refreshUI = () => {
    populateVocabulary();
    currentSentence = Model.getRandomSentence();
    loadSentence(currentSentence);
    updateStatisticsDisplay();
  };

  // 初始化文件上传
  const initFileUpload = () => {
    elements.uploadBtn.addEventListener('click', () => {
      elements.corpusFile.click();
    });
    
    elements.corpusFile.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      elements.fileName.textContent = file.name;
      elements.uploadStatus.textContent = '正在加载语料库...';
      elements.uploadStatus.className = 'upload-status';
      elements.uploadStatus.style.display = 'block';
      
      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const data = JSON.parse(event.target.result);
          
          if (!data.sentences || !Array.isArray(data.sentences)) {
            throw new Error('无效的语料库格式: 缺少句子数据');
          }
          
          Model.loadCorpus(data);
          
          elements.uploadStatus.textContent = '语料库加载成功！';
          elements.uploadStatus.className = 'upload-status success';
          
          refreshUI();
        } catch (error) {
          elements.uploadStatus.textContent = '加载失败: ' + error.message;
          elements.uploadStatus.className = 'upload-status error';
          console.error('语料库加载错误:', error);
        }
      };
      
      reader.onerror = function() {
        elements.uploadStatus.textContent = '文件读取失败';
        elements.uploadStatus.className = 'upload-status error';
      };
      
      reader.readAsText(file);
    });
  };
  
  // 初始化远程加载
  const initRemoteLoader = () => {
    elements.fetchJsonBtn.addEventListener('click', async () => {
      try {
        // 加载远程语料库
        const corpusData = await RemoteLoader.loadRemoteCorpus();
        
        // 加载语料库到模型
        Model.loadCorpus(corpusData);
        
        // 更新UI
        elements.fileName.textContent = "云端语料库";
        refreshUI();
        
        // 显示成功消息
        setTimeout(() => {
          alert("云端语料库加载成功！");
        }, 500);
        
      } catch (error) {
        console.error('加载远程语料库失败:', error);
      }
    });
  };

  // 初始化UI
  const initUI = () => {
    isAdvancedMode = false;
    elements.slot4.style.display = "none";
    elements.puzzleContainer.classList.add('simple-mode');
    
    // 初始化空状态文本
    elements.emptyState.querySelector('p').textContent = AppConfig.uiStrings.chinese.emptyStateText;
    
    populateVocabulary();
    currentSentence = Model.getRandomSentence();
    loadSentence(currentSentence);
    initDragAndDrop();
    initFileUpload();
    initRemoteLoader();
    updateStatisticsDisplay();
    
    // 暴露变量给移动点击模块（保持可变引用）
    window.UI = window.UI || {};
    window.UI.isAdvancedMode = isAdvancedMode;
    window.UI.currentFirstInitialSlot = currentFirstInitialSlot;
    
    elements.simpleModeBtn.addEventListener("click", () => {
      isAdvancedMode = false;
      window.UI.isAdvancedMode = false;
      elements.simpleModeBtn.classList.add("active");
      elements.advancedModeBtn.classList.remove("active");
      elements.slot4.style.display = "none";
      elements.puzzleContainer.classList.add('simple-mode');
      currentSentence = Model.getRandomSentence();
      loadSentence(currentSentence);
    });
    
    elements.advancedModeBtn.addEventListener("click", () => {
      isAdvancedMode = true;
      window.UI.isAdvancedMode = true;
      elements.advancedModeBtn.classList.add("active");
      elements.simpleModeBtn.classList.remove("active");
      elements.slot4.style.display = "block";
      elements.puzzleContainer.classList.remove('simple-mode');
      currentSentence = Model.getRandomSentence();
      loadSentence(currentSentence);
      showAdvancedTip();
    });
    
    elements.resetBtn.addEventListener("click", () => loadSentence(currentSentence));
    
    elements.nextBtn.addEventListener("click", () => {
      if (!isSubmitted) {
        const placedBasic = [elements.slot1, elements.slot2, elements.slot3]
          .filter(s => s.firstChild && (s.firstChild.textContent ?? "") !== "").length;
        const placed = isAdvancedMode ? placedBasic + (elements.slot4.firstChild ? 1 : 0) : placedBasic;
        if (placed < 2) {
          consecutiveNextClicks += 1;
          if (consecutiveNextClicks === 1) {
            showWarn('已跳过1题：请尽量尝试作答！');
            currentSentence = Model.getRandomSentence();
            loadSentence(currentSentence);
        return;
      }
          showWarn('已禁止跳过，请先完成拼图再提交！');
          elements.nextBtn.disabled = true;
          return;
        }
        showWarn('请先提交答案，再进行下一题！');
        return;
      }
      consecutiveNextClicks = 0;
      elements.nextBtn.disabled = false;
      currentSentence = Model.getRandomSentence();
      loadSentence(currentSentence);
    });
    
    elements.submitBtn.addEventListener("click", () => {
      if (currentSentence.isCompleted) return;
      // 至少有2个拼图块被放入即可允许提交（适配slot允许为空的题型）
      const placedBasic = [elements.slot1, elements.slot2, elements.slot3]
        .filter(s => s.firstChild && (s.firstChild.textContent ?? "") !== "").length;
      const placed = isAdvancedMode ? placedBasic + (elements.slot4.firstChild ? 1 : 0) : placedBasic;
      if (placed < 2) {
        // 视为跳过，允许一次
        consecutiveNextClicks += 1;
        if (consecutiveNextClicks === 1) {
          showWarn('已跳过1题：请尽量先尝试作答；再次跳过将被禁止');
          currentSentence = Model.getRandomSentence();
          loadSentence(currentSentence);
          return;
        }
        showWarn('已禁止跳过，请完成拼图再提交');
        elements.nextBtn.disabled = true;
        return;
      }
      
      const userAnswers = {
        slot1: elements.slot1.firstChild?.textContent || "",
        slot2: elements.slot2.firstChild?.textContent || "",
        slot3: elements.slot3.firstChild?.textContent || "",
        slot4: elements.slot4.firstChild?.textContent || ""
      };
      
      const scoreResult = Algorithm.calculateScore(
        userAnswers, 
        currentSentence.parts, 
        isAdvancedMode
      );
      
      showScoreFeedback(scoreResult);
      // 提交后释放“下一题”按钮
      consecutiveNextClicks = 0;
      elements.nextBtn.disabled = false;
    });
    
    document.addEventListener("drop", e => e.preventDefault(), false);
    document.addEventListener("dragover", e => e.preventDefault(), false);
  };

  return {
    initUI
  };
})();

// 主程序 - 初始化应用
document.addEventListener('DOMContentLoaded', () => {
  UI.initUI();
  
  // 添加点击单词库激活效果
  document.getElementById('wordBank').addEventListener('click', function() {
    this.classList.add('active');
    setTimeout(() => this.classList.remove('active'), 300);
  });
  
      // 初始化移动端点击功能
    setTimeout(() => {
      MobileClick.initClickSelection();
    }, 100);
});
</script>
</body>
</html>

