<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>至元德语 - 造句练习器 A1-1</title>
<style>
* { 
    box-sizing: border-box; 
    margin: 0; 
    padding: 0; 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    touch-action: manipulation;
}
body { 
    background: linear-gradient(135deg, rgba(26,42,108,0.9), rgba(178,31,31,0.9), rgba(26,42,108,0.9)); 
    color: #333; 
    line-height: 1.6; 
    padding: 12px; 
    min-height: 100vh; 
    display: flex;
    flex-direction: column;
}
.container { 
    max-width: 1200px; 
    margin: 0 auto; 
    padding: 12px; 
    flex: 1;
}
header { 
    display: flex; 
    flex-direction: column; 
    justify-content: space-between; 
    color: white; 
    text-shadow: 0 2px 4px rgba(0,0,0,0.3); 
    margin-bottom: 12px; 
    padding: 10px 0;
}
.header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}
.header-title {
    flex: 1;
    min-width: 0;
    max-width: 100%;
}
h1 { 
    font-size: 1.4rem; 
    margin-bottom: 4px; 
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 100%;
}
.tool-description { 
    background: rgba(255, 255, 255, 0.2); 
    border-radius: 8px; 
    padding: 8px; 
    font-size: 0.85rem; 
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    line-height: 1.4;
    max-height: 3.2em;
    width: 100%;
}
.mode-container {
    display: flex;
    flex-direction: column;
    min-width: 150px;
}
.mode-title {
    font-weight: bold;
    font-size: 0.95rem;
    opacity: 0.9;
    margin-bottom: 6px;
    text-align: right;
    white-space: nowrap;
}
.mode-selector { 
    display: flex; 
    gap: 6px; 
    width: 100%;
}
.mode-btn { 
    height: 32px;
    line-height: 32px;
    padding: 0 10px; 
    border-radius: 18px; 
    border: 2px solid #ffcc00; 
    color: #ffcc00; 
    background: rgba(255,255,255,0.1); 
    cursor: pointer; 
    font-weight: bold; 
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    justify-content: center;
    flex: 1;
    min-width: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: all 0.3s ease;
}
.mode-btn.active { 
    background: #ffcc00; 
    color: #1a2a6c; 
}
.mode-btn:hover {
    background: rgba(255, 204, 0, 0.3);
}
.main-content { 
    display: flex; 
    flex-direction: column; 
    gap: 16px; 
}
.exercise-section, .theory-section { 
    background: rgba(255,255,255,0.92); 
    border-radius: 12px; 
    padding: 16px; 
    box-shadow: 0 5px 15px rgba(0,0,0,0.15); 
}
.section-title { 
    font-size: 1.3rem; 
    color: #1a2a6c; 
    margin-bottom: 12px; 
    border-bottom: 2px solid #1a2a6c; 
    text-align: center; 
    padding-bottom: 8px;
    position: relative;
}
.puzzle-container-wrapper {
  margin-top: 18px;
  position: relative;
}
.puzzle-container { 
    display: flex; 
    flex-wrap: wrap; 
    gap: 11px; 
    margin: 0; 
    justify-content: center;
}
.puzzle-slot { 
    flex: 0 0 auto;
    min-width: 104px; 
    max-width: 138px; 
    height: 50px;
    border: 2px dashed #1a2a6c; 
    border-radius: 8px; 
    padding: 2px; 
    background: #f8f9fa; 
    position: relative; 
    text-align: center; 
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 22px;
}
.puzzle-slot.punctuation-slot {
    min-width: 90px; 
    max-width: 120px; 
}
.puzzle-slot::before { 
    content: attr(data-label); 
    position: absolute; 
    top: -24px; 
    left: 50%; 
    transform: translateX(-50%); 
    background: #1a2a6c; 
    color: white; 
    font-size: 0.8rem; 
    padding: 3px 8px; 
    border-radius: 8px; 
    white-space: nowrap;
    z-index: 10;
}
.word-bank { 
    display: flex; 
    flex-wrap: wrap; 
    gap: 8px; 
    margin: 0; 
    justify-content: center;
    min-height: 70px;
    padding: 9px 10px;
    background: rgba(0,0,0,0.03);
    border-radius: 8px;
    transition: background 0.3s;
}
.word-bank.active {
    background: rgba(255, 204, 0, 0.1);
}
.puzzle-piece { 
    background: #e3f2fd; 
    padding: 8px 12px; 
    border-radius: 6px; 
    font-weight: bold; 
    cursor: move; 
    min-width: 70px; 
    text-align: center; 
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.95rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    user-select: none;
    -webkit-tap-highlight-color: transparent;
    position: relative;
    transition: all 0.2s ease;
}
.puzzle-piece:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}
.puzzle-slot > .puzzle-piece {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    min-width: auto;
    box-shadow: none;
}
.puzzle-piece.punctuation { 
    background: #d7ccc8; 
}
.puzzle-piece.empty-slot { background: #e3f2fd; border: none; }
.puzzle-piece.empty-slot::after { content: ""; }
.controls { 
    display: flex; 
    flex-wrap: wrap;
    justify-content: center; 
    gap: 8px; 
    margin-top: 16px; 
    position: relative;
}
.btn { 
    padding: 8px 14px; 
    border-radius: 8px; 
    font-weight: bold; 
    cursor: pointer; 
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    font-size: 0.95rem;
    min-width: 95px; 
    flex: 1;
    max-width: 143px; 
}
.btn-secondary { 
    background: #6c757d; 
    color: white; 
}
.btn-secondary:hover {
    background: #5a6268;
}
.btn-success { 
    background: #28a745; 
    color: white; 
}
.btn-success:hover {
    background: #218838;
}
.btn-submit {
    background: #ffcc00;
    color: #1a2a6c;
    font-weight: bold;
    min-width: 132px; 
    max-width: 165px; 
}
.btn-submit:hover {
    background: #e6b800;
}
.feedback { 
    margin-top: 16px; 
    padding: 12px; 
    border-radius: 8px; 
    display: block; 
    background: #d4edda;
    color: #155724; 
    border: 2px solid #c3e6cb;
    animation: fadeIn 0.5s ease;
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
.feedback-header {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between; 
    align-items: center;
    margin-bottom: 12px;
    gap: 8px;
}
.feedback-title {
    font-size: 1.2rem; 
    color: #1a2a6c;
    font-weight: bold;
    flex: 1;
    min-width: 150px;
}
.current-score-container {
    font-size: 1.3rem;
    font-weight: bold;
    min-width: 100px;
    text-align: right;
}
.current-score-container.high {
    color: #28a745;
}
.current-score-container.low {
    color: #dc3545;
}
.score-details { 
    display: grid; 
    grid-template-columns: repeat(2, 1fr); 
    gap: 10px; 
    margin-top: 12px; 
}
.score-item { 
    background: rgba(255,255,255,0.7); 
    padding: 8px; 
    border-radius: 8px; 
    text-align: center; 
}
.score-value { 
    font-size: 1.1rem; 
    font-weight: bold; 
    color: #1a2a6c; 
    display: block;
    margin-top: 4px;
}
.score-item.error .score-value { 
    color: #dc3545;
}
.reference-answer {
    text-align: center;
    font-size: 1.1rem;
    font-weight: bold;
    margin: 12px 0;
    padding: 8px;
    background: rgba(255,255,255,0.7);
    border-radius: 8px;
    border-left: 4px solid #1a2a6c;
}
.vocab-section { 
    margin-bottom: 8px; 
    padding: 2px; 
    border-radius: 8px; 
}
.vocab-container { 
    display: flex; 
    flex-wrap: wrap; 
    gap: 6px; 
    justify-content: center;
}
.vocab-item { 
    background: white; 
    padding: 6px 10px;
    border-radius: 5px; 
    font-size: 0.9rem; 
    font-weight: 500; 
    color: #1a2a6c; 
    min-width: 80px;
    text-align: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    flex: 1;
    transition: transform 0.2s;
}
.vocab-item:hover {
    transform: scale(1.05);
}
.copyright { 
    text-align: center; 
    font-size: 0.85rem; 
    margin-top: 20px; 
    padding: 10px 15px;
    background: rgba(255, 255, 255, 0.25);
    border-radius: 8px;
    color: #fff;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}
.theory-card {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 12px;
    margin-top: 12px;
    border: 1px solid #ddd;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    font-size: 0.95rem;
    width: 100%;
}
.theory-card ul {
    padding-left: 20px;
    margin: 12px 0;
}
.theory-card li {
    margin-bottom: 6px;
    line-height: 1.5;
}
.theory-card li li {
    font-size: 0.9em;
    line-height: 1.4;
}
.advanced-tip {
    position: fixed;
    top: 70px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255, 255, 255, 0.9);
    color: #1a2a6c;
    padding: 8px 16px;
    border-radius: 30px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.5s ease-in-out;
    pointer-events: none;
    font-weight: bold;
    max-width: 90%;
    text-align: center;
    font-size: 0.95rem;
}
.advanced-tip.show {
    opacity: 1;
}
.btn-icon {
    margin-left: 6px;
    font-size: 1.05em;
}
.sentence-info {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    margin-bottom: 0;
    padding: 10px;
    background: #e3f2fd;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: bold;
    color: #1a2a6c;
    text-align: center;
}
.translation-text {
    text-decoration: underline;
    text-decoration-thickness: 1.5px;
    text-underline-offset: 3px;
    margin-left: 4px;
    font-weight: bold;
    display: inline-block;
    margin-top: 4px;
    flex: 1;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
}
.next-button-warning {
    position: absolute;
    top: -32px;
    left: 50%;
    transform: translateX(-50%);
    background: #dc3545;
    color: white;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    opacity: 0;
    transition: opacity 0.3s ease;
    white-space: nowrap;
    pointer-events: none;
    width: max-content;
    max-width: 90%;
}
.next-button-warning.show {
    opacity: 1;
}
.reading-indicator { 
    display:flex; 
    gap:6px; 
    align-items: center;
    justify-content: center;
    margin-top: 0; 
    position: absolute;
    right: 12px;
    top: calc(50% - 15px);
    transform: translateY(-50%);
    pointer-events: none;
    z-index: 1001;
}
.reading-dot { 
    width:10px; 
    height:10px; 
    border-radius:50%; 
    background:#bbb; 
    transition: background .18s, box-shadow .18s; 
}
.reading-indicator.speaking .dot1 { animation: dot1Anim 1.2s linear infinite; }
.reading-indicator.speaking .dot2 { animation: dot2Anim 1.2s linear infinite; }
.reading-indicator.speaking .dot3 { animation: dot3Anim 1.2s linear infinite; }
@keyframes dot1Anim { 0%,100%{background:#4CAF50; box-shadow:0 0 8px rgba(76,175,80,0.95);} 25%,50%,75%{background:#bbb; box-shadow:none;} }
@keyframes dot2Anim { 25%,75%{background:#4CAF50; box-shadow:0 0 8px rgba(76,175,80,0.95);} 0%,50%,100%{background:#bbb; box-shadow:none;} }
@keyframes dot3Anim { 50%{background:#4CAF50; box-shadow:0 0 8px rgba(76,175,80,0.95);} 0%,25%,75%,100%{background:#bbb; box-shadow:none;} }

.file-upload-container {
    background: rgba(255,255,255,0.92);
    border-radius: 12px;
    padding: 16px;
    margin-top: 16px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.15);
}
.file-upload-header {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
    flex-wrap: wrap;
    gap: 10px;
}
.file-upload-btn {
    background: #1a2a6c;
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    display: inline-flex;
    align-items: center;
    min-width: 150px;
    justify-content: center;
    border: none;
    transition: background 0.2s;
}
.file-upload-btn:hover {
    background: #0e1a4a;
}
.file-upload-btn svg {
    margin-right: 8px;
}
.file-name {
    margin-left: 12px;
    font-size: 0.9rem;
    color: #666;
    flex: 1;
    min-width: 200px;
}
.upload-status {
    margin-top: 12px;
    padding: 10px;
    border-radius: 8px;
    text-align: center;
    font-weight: bold;
    display: none;
}
.upload-status.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
    display: block;
}
.upload-status.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
    display: block;
}

.sentence-puzzle-header {
    position: relative;
    padding-bottom: 6px;
}

/* 移动端样式 */
@media (max-width: 767px) {
  .puzzle-piece {
    cursor: pointer;
  }
  .puzzle-slot.filled {
    cursor: pointer;
  }
  .puzzle-slot.filled .puzzle-piece {
    transform: scale(1.05);
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
  }
  .puzzle-slot.filled .puzzle-piece:hover {
    transform: scale(1.1);
    box-shadow: 0 0 15px rgba(0,0,0,0.3);
  }
  .mobile-tip {
    display: block;
    text-align: center;
    font-size: 0.9rem;
    color: #1a2a6c;
    background: rgba(255, 255, 255, 0.5);
    padding: 6px;
    border-radius: 8px;
    margin-top: 8px;
  }
}
@media (min-width: 768px) {
  .mobile-tip {
    display: none;
  }
}

/* 桌面版样式 */
@media (min-width: 768px) {
    .container {
        padding: 20px;
    }
    header { 
        flex-direction: row; 
        align-items: flex-end;
        padding: 0;
        margin-bottom: 20px;
    }
    .header-top {
        flex-direction: row;
        align-items: flex-end;
        margin-bottom: 0;
    }
    .header-title {
        margin-right: 20px;
        max-width: calc(100% - 200px);
    }
    h1 { 
        font-size: 1.8rem; 
        max-width: 100%;
    }
    .tool-description {
        font-size: 0.95rem;
        padding: 10px;
        max-height: none;
        -webkit-line-clamp: unset;
        max-width: 100%;
    }
    .mode-container {
        min-width: 180px;
    }
    .mode-title {
        font-size: 1.05rem;
    }
    .mode-btn {
        font-size: 1rem;
        height: 36px;
    }
    .main-content { 
        display: grid; 
        grid-template-columns: 1fr 350px; 
        gap: 20px; 
    }
    .section-title {
        font-size: 1.5rem;
    }
    .puzzle-container { 
        justify-content: center;
        gap: 11px; 
    }
    .puzzle-slot {
        min-width: 115px;  
        max-width: 173px;  
        margin-bottom: 22px;
    }
    .puzzle-slot.punctuation-slot {
        min-width: 100px;   
        max-width: 150px;   
    }
    .score-details { 
        grid-template-columns: repeat(4, 1fr); 
    }
    .sentence-info {
        text-align: left;
        justify-content: flex-start;
    }
    .translation-text {
        margin-top: 0;
        margin-left: 5px;
    }
    .file-upload-header {
        flex-wrap: nowrap;
    }
    
    .header-left {
        max-width: calc(100% - 200px);
    }
    .tool-description {
        max-width: 100%;
    }
}

@media (min-width: 992px) {
    h1 {
        font-size: 2rem;
        max-width: 100%;
    }
    .mode-container {
        min-width: 250px;
    }
    
    h1 {
        font-size: clamp(1.8rem, 3vw, 2rem);
        white-space: normal;
        overflow: visible;
        line-height: 1.2;
    }
}

.header-grid {
  display: grid;
  grid-template-columns: 1fr auto;
  grid-template-areas: "left right";
  gap: 15px;
  margin-bottom: 20px;
  align-items: center;
}
.header-left { grid-area: left; display: flex; flex-direction: column; gap: 8px; }
.header-right { grid-area: right; display: flex; flex-direction: column; align-items: flex-end; gap: 8px; }
.stats-section { background: rgba(255,255,255,0.92); border-radius: 12px; padding: 16px; margin-top: 16px; box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
.stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
.stats-item { background: rgba(255,255,255,0.7); padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; color: #1a2a6c; }
.stats-value { display: block; margin-top: 5px; font-size: 1.15rem; }
.corpus-section-compressed { background: rgba(255,255,255,0.92); border-radius: 12px; padding: 12px; margin-top: 16px; box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
.corpus-title-inline { font-size: 1.5rem; color: #1a2a6c; font-weight: bold; margin-bottom: 8px; text-align: left; }
.file-upload-container { display: flex; flex-direction: column; gap: 8px; }
.file-upload-row { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
.file-upload-btn { background: #1a2a6c; color: #fff; border: none; border-radius: 8px; padding: 8px 14px; font-weight: bold; cursor: pointer; }
.file-name { color: #333; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 60%; }
.upload-status { font-size: 0.95rem; color: #555; }

.main-content {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 20px;
}
@media (max-width: 991px) {
  .main-content { grid-template-columns: 1fr; }
}
.left-column {
  display: flex;
  flex-direction: column;
  gap: 16px;
  min-height: 100%;
}
.stats-section {
  background: rgba(255,255,255,0.92);
  border-radius: 12px;
  padding: 16px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.15);
}
.stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
.stats-item { background: rgba(255,255,255,0.7); padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; color: #1a2a6c; }
.stats-value { display: block; margin-top: 5px; font-size: 1.1rem; }

.corpus-management-section {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 16px;
  margin-top: 16px;
  border: 1px solid #ddd;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.corpus-header {
  font-size: 1.2rem;
  color: #1a2a6c;
  font-weight: bold;
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 1px solid #ddd;
}

.upload-row {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 12px;
}

.upload-controls {
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 1;
  min-width: 200px;
}

.upload-status-container {
  flex: 1;
  min-width: 50%;
  text-align: right;
}

.corpus-hint {
  font-size: 0.85rem;
  color: #666;
  flex: 1;
  min-width: 100%;
  padding: 8px;
  background: rgba(255,255,255,0.7);
  border-radius: 6px;
  text-align: center;
  width: 350px;
}

@media (min-width: 768px) {
  .upload-row {
    flex-wrap: nowrap;
    align-items: center;
  }
  
  .upload-controls {
    flex: 2;
  }
  
  .upload-status-container {
    flex: 1;
    min-width: 0;
    align-self: stretch;
    display: flex;
    align-items: center;
    justify-content: flex-end;
  }
  
  .corpus-hint {
    min-width: 0;
    flex: 3;
    text-align: right;
    align-self: stretch;
    display: flex;
    align-items: center;
    justify-content: center;
    padding-right: 20px;
  }
  
  .upload-status {
    margin-top: 0;
    width: 100%;
    text-align: right;
  }
}

.puzzle-container.simple-mode .puzzle-slot {
  min-width: 104px !important;
  max-width: 138px !important;
  flex: 0 0 calc(33.333% - 15px) !important;
}

@media (max-width: 767px) {
  .puzzle-container.simple-mode .puzzle-slot {
    min-width: 104px !important;
    max-width: 138px !important;
  }
}

.puzzle-slot:empty::after {
  content: "↓ 放置位置";
  color: #999;
  font-size: 0.7rem;
  font-style: italic;
  position: absolute;
  top: 50%;
  left: 0;
  right: 0;
  transform: translateY(-50%);
  text-align: center;
}

/* 空状态引导样式 */
.empty-state {
    text-align: center;
    padding: 16px;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 8px;
    margin: 10px 0;
    display: none;
}
.empty-state.show {
    display: block;
}
.empty-state p {
    margin-bottom: 10px;
    font-weight: bold;
    color: #1a2a6c;
}
.guide-animation {
    font-size: 2rem;
    animation: bounce 1.5s infinite;
}
@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

/* 加载动画样式 */
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loading-spinner {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top-color: white;
  animation: spin 1s ease-in-out infinite;
  margin-right: 8px;
}

/* 初始提示样式 */
.initial-hint {
    text-align: center;
    padding: 20px;
    color: #666;
    font-style: italic;
}

/* 降低动画以提升低端设备流畅度 */
@media (prefers-reduced-motion: reduce) {
  * { transition: none !important; animation: none !important; }
}
</style>
</head>
<body>
<div class="container">
<div class="advanced-tip" id="advancedTip">提示：进阶模式下有部分拼图不需要</div>
<header class="header-grid">
  <div class="header-left">
    <h1>至元德语 - 造句练习器 A1-1</h1>
    <p class="tool-description">完成拼图，掌握德语四大句型和动词第二位规律</p>
  </div>
  <div class="header-right">
    <div class="mode-title">句型和动词的位置练习</div>
    <div class="mode-selector">
      <div class="mode-btn active" id="simpleModeBtn">简单模式</div>
      <div class="mode-btn" id="advancedModeBtn">进阶模式</div>
    </div>
  </div>
  <div aria-hidden="true" class="reading-indicator" id="readingIndicator">
    <div class="reading-dot dot1"></div>
    <div class="reading-dot dot2"></div>
    <div class="reading-dot dot3"></div>
  </div>
</header>

<div class="main-content">
  <div class="left-column">
    <section class="exercise-section">
      <div class="sentence-puzzle-header">
        <h2 class="section-title">句型拼图练习</h2>
      </div>
      <div class="sentence-info">
        中文：<span class="translation-text" id="currentTranslation">请上传语料库开始练习</span>
      </div>
      
      <div class="empty-state" id="emptyState">
        <p>请从下方词汇区拖拽单词到句子框架中</p>
        <div class="guide-animation">↓</div>
      </div>
      
      <div class="puzzle-container-wrapper">
        <div class="puzzle-container" id="puzzleContainer">
          <div class="puzzle-slot" data-label="第1位" id="slot1"></div>
          <div class="puzzle-slot" data-label="第2位" id="slot2"></div>
          <div class="puzzle-slot" data-label="其他位" id="slot3"></div>
          <div class="puzzle-slot punctuation-slot" data-label="标点" id="slot4"></div>
        </div>
      </div>
      
      <div class="word-bank" id="wordBank"></div>
      <div class="controls">
        <button class="btn btn-secondary" id="resetBtn">重置拼图</button>
        <button class="btn btn-submit" id="submitBtn">提交答案 <span class="btn-icon">💡</span></button>
        <button class="btn btn-success" id="nextBtn">下一题</button>
        <div class="next-button-warning" id="nextButtonWarning">请先提交答案，再进行下一题！</div>
      </div>
      <div class="feedback" id="feedback">
        <div class="feedback-header">
          <h3 class="feedback-title">评价及解析</h3>
          <div class="current-score-container" id="currentScoreContainer">
            得分：<span id="currentScore">0</span> / <span id="maxScore">5</span>
          </div>
        </div>
        <div class="reference-answer">参考答案: <span id="referenceAnswer"></span></div>
        <div class="score-details">
          <div class="score-item"><div>第1位</div><div class="score-value" id="slot1Score">0</div></div>
          <div class="score-item"><div>第2位</div><div class="score-value" id="slot2Score">0</div></div>
          <div class="score-item"><div>其他位</div><div class="score-value" id="slot3Score">0</div></div>
          <div class="score-item"><div>标点</div><div class="score-value" id="slot4Score">0</div></div>
        </div>
        <div class="initial-hint" id="initialHint">完成练习后，这里会显示答案解析和得分</div>
      </div>
    </section>
    <section class="stats-section">
      <div class="stats-grid">
        <div class="stats-item">完成题数<span class="stats-value" id="totalCompleted">0</span></div>
        <div class="stats-item">正确率<span class="stats-value" id="accuracy">0%</span></div>
        <div class="stats-item">高频错误<span class="stats-value" id="topErrors">-</span></div>
        <div class="stats-item">剩余答题数<span class="stats-value" id="remainingQuestions">0</span></div>
      </div>
    </section>
  </div>
  
  <section class="theory-section">
    <h2 class="section-title">练习要点</h2>
    <div style="margin-top:10px;">
      <h3 style="color:#1a2a6c;">练习词汇表</h3>
      <div id="vocabContainer"></div>
    </div>
    <div style="margin-top:16px;">
      <h3 style="color:#1a2a6c;">语法小贴士</h3>
      <div class="theory-card">
        <ul>
          <li>第1位先确定句型，再选择内容</li>
          <li>四大句型和第1位的关系:
            <ul>
              <li>陈述句的第1位通常是主语或其他</li>
              <li>W-疑问句第1位是W-疑问词</li>
              <li>命令句和Ja/Nein疑问句第1位空缺</li>
            </ul>
          </li>
          <li>始终注意动词的位置 - 必须在第二位</li>
        </ul>
      </div>
    </div>
  </section>
</div>

<!-- 语料库管理区域 -->
<section class="corpus-management-section">
  <div class="corpus-header">语料库管理</div>
  <div class="upload-row">
    <div class="upload-controls">
      <button class="file-upload-btn" id="uploadBtn">
        <svg fill="none" height="20" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="20" aria-hidden="true">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="17 8 12 3 7 8"></polyline>
          <line x1="12" x2="12" y1="3" y2="15"></line>
        </svg>
        上传本地语料
      </button>
      <button class="file-upload-btn" id="fetchJsonBtn" style="background:#2a6c1a;">
        <svg fill="white" height="20" viewBox="0 0 24 24" width="20" aria-hidden="true">
          <path d="M12 21c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm6-7h-1.7c0 3-2.5 5.1-5.3 5.1S6.7 17 6.7 14H5c0 3.4 2.7 6.2 6 6.7V23h2v-2.3c3.3-.5 6-3.3 6-6.7zm-9-9.9V1h2v3.1c3.4.5 6 3.3 6 6.7h-1.7c0-3-2.5-5.1-5.3-5.1S6.7 7 6.7 10H5c0-3.4 2.7-6.2 6-6.7z"/>
        </svg>
        获取云端语料
      </button>
      <input type="file" id="corpusFile" accept=".json" style="display:none;">
      <span class="file-name" id="fileName">未选择文件</span>
    </div>
    
    <div class="upload-status-container">
      <div class="upload-status" id="uploadStatus"></div>
    </div>
    
    <div class="corpus-hint">
      请选择本地上传或云端加载语料库json
    </div>
  </div>
</section>

<div class="copyright">© 2025 至元德语原创开发，仅供内部学生使用，未经书面许可禁止复制、传播或商用。</div>
<script>
/* 应用程序配置 */
const AppConfig = {
  REMOTE_URL: "https://zydeutsch-chen.github.io/ZYDetusch-model/A1-1sentences-encrypted.json",
  exerciseType: 'A1-1',
  slots: {
    labels: ['第1位', '第2位', '其他位', '标点'],
    scoring: {
      simple: { slot1: 2, slot2: 2, slot3: 1 },
      advanced: { slot1: 1.5, slot2: 2, slot3: 1, slot4: 0.5 }
    }
  },
  vocabCategories: [
    { id: 'questionWords', name: '疑问词', color: '#ffcc80' },
    { id: 'verbs', name: '动词', color: '#a5d6a7' },
    { id: 'subjects', name: '主语', color: '#90caf9' },
    { id: 'others', name: '其他', color: '#f48fb1' }
  ],
  uiStrings: {
    chinese: {
      uploadHint: '请选择本地上传或云端加载语料库json',
      emptyStateText: '请从下方词汇区拖拽单词到句子框架中',
      nextButtonWarning: '请先提交答案，再进行下一题！',
      advancedTip: '提示：进阶模式下有部分拼图不需要'
    }
  }
};

/* 解密模块（缓存编码器以减少分配） */
const Decryptor = {
  _encoder: new TextEncoder(),
  _decoder: new TextDecoder(),
  decryptCorpusIfNeeded(payload) {
    try {
      if (typeof payload === 'object') return payload;
      const trimmedPayload = (payload || '').trim();
      if (trimmedPayload.startsWith('{') || trimmedPayload.startsWith('[')) {
        return JSON.parse(trimmedPayload);
      }
      const keySuffix = "et";
      let processedPayload = trimmedPayload;
      if (processedPayload.endsWith(keySuffix)) {
        processedPayload = processedPayload.slice(0, -keySuffix.length);
      }
      let base64Str = processedPayload
        .replace(/^data:[^;]+;base64,/, '')
        .replace(/[\s\n]/g, '')
        .replace(/-/g, '+').replace(/_/g, '/');
      const pad = base64Str.length % 4;
      if (pad) base64Str += '='.repeat(4 - pad);
      const binaryString = atob(base64Str);
      const bytes = new Uint8Array(binaryString.length);
      for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
      const plainBytes = this.xorWithKey(bytes, "ZY-secret");
      const jsonStr = this._decoder.decode(plainBytes);
      return JSON.parse(jsonStr);
    } catch (error) {
      console.error('解密失败:', error);
      throw new Error(`解密失败: ${error.message}`);
    }
  },
  xorWithKey(bytes, key) {
    const keyBytes = this._encoder.encode(key);
    const result = new Uint8Array(bytes.length);
    for (let i = 0; i < bytes.length; i++) result[i] = bytes[i] ^ keyBytes[i % keyBytes.length];
    return result;
  }
};

/* 远程加载模块 */
const RemoteLoader = {
  async loadRemoteCorpus() {
    const statusElement = document.getElementById('uploadStatus');
    const fetchBtn = document.getElementById('fetchJsonBtn');
    const originalBtnText = fetchBtn.innerHTML;
    try {
      statusElement.textContent = '正在连接服务器...';
      statusElement.className = 'upload-status';
      statusElement.style.display = 'block';
      fetchBtn.disabled = true;
      fetchBtn.innerHTML = '<div class="loading-spinner"></div>获取中...';
      const response = await fetch(AppConfig.REMOTE_URL);
      if (!response.ok) throw new Error(`网络错误: ${response.status} ${response.statusText}`);
      const encryptedText = await response.text();
      statusElement.textContent = '正在解密数据...';
      const corpusData = Decryptor.decryptCorpusIfNeeded(encryptedText);
      if (!corpusData.sentences || !Array.isArray(corpusData.sentences)) throw new Error("无效的语料库格式: 缺少句子数据");
      if (!corpusData.vocabulary || typeof corpusData.vocabulary !== 'object') throw new Error("无效的语料库格式: 缺少词汇表数据");
      statusElement.textContent = '语料库加载成功！';
      statusElement.className = 'upload-status success';
      return corpusData;
    } catch (error) {
      console.error('加载远程语料库失败:', error);
      statusElement.textContent = `错误: ${error.message}`;
      statusElement.className = 'upload-status error';
      throw error;
    } finally {
      fetchBtn.innerHTML = originalBtnText;
      fetchBtn.disabled = false;
    }
  }
};

/* 数据模型 */
const Model = (() => {
  let sentences = [];
  let vocabulary = {
    questionWords: new Set(),
    verbs: new Set(),
    subjects: new Set(),
    others: new Set(),
    punctuation: new Set([".", "?"])
  };
  let statistics = {
    totalCompleted: 0,
    perfectCount: 0,
    errorCounts: { slot1: 0, slot2: 0, slot3: 0 },
    answeredCount: 0,
    totalErrors: 0,
    totalQuestions: 0
  };
  let usedIndices = new Set();
  const loadCorpus = (data) => {
    if (!data.sentences || !Array.isArray(data.sentences)) throw new Error('无效的语料库格式: 缺少句子数据');
    sentences = data.sentences.map(s => {
      const parts = {...s.parts};
      Object.keys(parts).forEach(key => { if (parts[key] === "空缺") parts[key] = ""; });
      return {...s, parts};
    });
    vocabulary.questionWords = new Set(data.vocabulary?.questionWords || []);
    vocabulary.verbs = new Set(data.vocabulary?.verbs || []);
    vocabulary.subjects = new Set(data.vocabulary?.subjects || []);
    vocabulary.others = new Set(data.vocabulary?.others || []);
    vocabulary.punctuation = new Set(data.vocabulary?.punctuation || [".", "?"]);
    usedIndices = new Set();
    statistics.totalQuestions = sentences.length;
    return true;
  };
  const getRandomSentence = () => {
    if (sentences.length === 0) {
      return { parts: {slot1: "", slot2: "", slot3: "", slot4: ""}, full: "请上传语料库", translation: "请上传语料库开始练习", weight: 1 };
    }
    if (usedIndices.size >= 50 || usedIndices.size === sentences.length) {
      return { parts: {slot1: "", slot2: "", slot3: "", slot4: ""}, full: "恭喜你，你已完成所有练习！", translation: "恭喜你，你已完成所有练习！", weight: 1, isCompleted: true };
    }
    const availableIndices = [];
    sentences.forEach((_, index) => { if (!usedIndices.has(index)) availableIndices.push(index); });
    const totalWeight = availableIndices.reduce((sum, index) => sum + sentences[index].weight, 0);
    let random = Math.random() * totalWeight;
    for (const index of availableIndices) {
      random -= sentences[index].weight;
      if (random <= 0) { usedIndices.add(index); return sentences[index]; }
    }
    return sentences[availableIndices[0]];
  };
  const updateStatistics = (scoreResult, isAdvancedMode) => {
    statistics.totalCompleted += 1;
    statistics.answeredCount += 1;
    if (scoreResult.total < 5) statistics.totalErrors += 1;
    if (scoreResult.total === 5) statistics.perfectCount += 1;
    const { scores } = scoreResult;
    if (scores.slot1 < (isAdvancedMode ? 1.5 : 2)) statistics.errorCounts.slot1 += 1;
    if (scores.slot2 < 2) statistics.errorCounts.slot2 += 1;
    if (scores.slot3 < 1) statistics.errorCounts.slot3 += 1;
  };
  const getStatistics = () => statistics;
  const getVocabulary = () => vocabulary;
  return { sentences, vocabulary, statistics, loadCorpus, getRandomSentence, updateStatistics, getStatistics, getVocabulary };
})();

/* 语音功能模块 */
const Speech = (() => {
  let userInteracted = false;
  let isSpeaking = false;
  let chineseVoice = null;
  let germanVoice = null;
  let voicesReady = false;
  let lastSpokenTranslation = "";
  const pickVoices = () => {
    const voices = window.speechSynthesis.getVoices();
    chineseVoice = voices.find(v => v.lang.includes('zh') && v.name.toLowerCase().includes('female')) || voices.find(v => v.lang.includes('zh')) || null;
    germanVoice = voices.find(v => (v.lang === 'de-DE' || v.lang === 'de-CH' || v.lang === 'de') && v.name.toLowerCase().includes('male')) || voices.find(v => v.lang.includes('de')) || null;
  };
  const initSpeech = () => {
    if (!userInteracted) return;
    if (!voicesReady) {
      const voices = window.speechSynthesis.getVoices();
      if (voices.length === 0) {
        window.speechSynthesis.onvoiceschanged = () => { voicesReady = true; pickVoices(); };
        return;
      }
      voicesReady = true;
    }
    pickVoices();
  };
  const speakChinese = (text) => {
    if (!userInteracted) return;
    if (lastSpokenTranslation === text) return;
    if (!chineseVoice) { initSpeech(); if (!chineseVoice) return; }
    if (isSpeaking) window.speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.voice = chineseVoice || null;
    utterance.lang = (chineseVoice && chineseVoice.lang) || 'zh-CN';
    utterance.rate = 0.9;
    const indicator = document.getElementById('readingIndicator');
    indicator && indicator.classList.add('speaking');
    isSpeaking = true;
    utterance.onend = () => { indicator && indicator.classList.remove('speaking'); isSpeaking = false; lastSpokenTranslation = text; };
    window.speechSynthesis.speak(utterance);
  };
  const speakGerman = (text) => {
    if (!userInteracted) return;
    if (!germanVoice) { initSpeech(); if (!germanVoice) return; }
    if (isSpeaking) window.speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.voice = germanVoice || null;
    utterance.lang = (germanVoice && germanVoice.lang) || 'de-DE';
    utterance.rate = 0.9;
    const indicator = document.getElementById('readingIndicator');
    indicator && indicator.classList.add('speaking');
    isSpeaking = true;
    utterance.onend = () => { indicator && indicator.classList.remove('speaking'); isSpeaking = false; };
    window.speechSynthesis.speak(utterance);
  };
  document.addEventListener('click', () => { if (!userInteracted) { userInteracted = true; initSpeech(); } });
  return { speakChinese, speakGerman };
})();

/* 算法模块 */
const Algorithm = (() => {
  const getAllVocabulary = () => {
    const allWords = new Set();
    Model.vocabulary.questionWords.forEach(word => allWords.add(word));
    Model.vocabulary.verbs.forEach(word => allWords.add(word));
    Model.vocabulary.subjects.forEach(word => allWords.add(word));
    Model.vocabulary.others.forEach(word => allWords.add(word));
    Model.vocabulary.punctuation.forEach(word => allWords.add(word));
    return allWords;
  };
  const getDistractorWords = (sentence) => {
    const distractorWords = getAllVocabulary();
    Object.values(sentence.parts).forEach(part => distractorWords.delete(part));
    distractorWords.delete(".");
    distractorWords.delete("?");
    distractorWords.delete("");
    return Array.from(distractorWords);
  };
  const calculateScore = (userAnswers, correctAnswers, isAdvancedMode) => {
    const scores = { slot1: 0, slot2: 0, slot3: 0, slot4: 0 };
    if (userAnswers.slot1 === correctAnswers.slot1) scores.slot1 = isAdvancedMode ? AppConfig.slots.scoring.advanced.slot1 : AppConfig.slots.scoring.simple.slot1;
    if (userAnswers.slot2 === correctAnswers.slot2) scores.slot2 = isAdvancedMode ? AppConfig.slots.scoring.advanced.slot2 : AppConfig.slots.scoring.simple.slot2;
    if (isAdvancedMode) {
      if (userAnswers.slot3 === correctAnswers.slot3) scores.slot3 = AppConfig.slots.scoring.advanced.slot3;
      if (userAnswers.slot4 === correctAnswers.slot4) scores.slot4 = AppConfig.slots.scoring.advanced.slot4;
    } else {
      const expectedSlot3 = (correctAnswers.slot3 || '') + (correctAnswers.slot4 || '');
      if (userAnswers.slot3 === expectedSlot3) scores.slot3 = AppConfig.slots.scoring.simple.slot3;
    }
    const total = Object.values(scores).reduce((sum, s) => sum + s, 0);
    return { scores, total: Math.round(total * 10) / 10 };
  };
  return { getDistractorWords, calculateScore };
})();

/* 移动端点击功能 */
const MobileClick = (() => {
  const isMobile = () => /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  let isClickEnabled = false;
  const initClickSelection = () => {
    if (!isMobile()) return;
    isClickEnabled = true;
    document.getElementById('wordBank').addEventListener('click', handleWordClick, { passive: true });
    document.getElementById('puzzleContainer').addEventListener('click', handleSlotClick, { passive: true });
    const mobileTip = document.createElement('div');
    mobileTip.className = 'mobile-tip';
    mobileTip.textContent = '提示：点击单词填充到句子中，点击句子中的单词可移除';
    document.querySelector('.puzzle-container-wrapper').appendChild(mobileTip);
  };
  const handleWordClick = (e) => {
    if (!isClickEnabled) return;
    const wordElement = e.target.closest('.puzzle-piece');
    if (!wordElement) return;
    const slots = [
      document.getElementById('slot1'),
      document.getElementById('slot2'),
      document.getElementById('slot3'),
      document.getElementById('slot4')
    ];
    const emptySlot = slots.find(slot => !slot.firstChild);
    if (!emptySlot) return;
    moveWordToSlot(wordElement, emptySlot);
  };
  const handleSlotClick = (e) => {
    if (!isClickEnabled) return;
    const slot = e.target.closest('.puzzle-slot');
    if (!slot || !slot.firstChild) return;
    removeWordFromSlot(slot);
  };
  const moveWordToSlot = (wordElement, slot) => {
    const clone = wordElement.cloneNode(true);
    if (UI.isAdvancedMode && slot.id === UI.currentFirstInitialSlot && clone.textContent) {
      clone.textContent = clone.textContent.charAt(0).toUpperCase() + clone.textContent.slice(1);
    }
    slot.appendChild(clone);
    wordElement.remove();
    slot.classList.add('filled');
  };
  const removeWordFromSlot = (slot) => {
    const wordElement = slot.firstChild;
    let originalText = wordElement.textContent;
    if (UI.isAdvancedMode && slot.id === UI.currentFirstInitialSlot && originalText) {
      originalText = originalText.charAt(0).toLowerCase() + originalText.slice(1);
    }
    wordElement.textContent = originalText;
    document.getElementById('wordBank').appendChild(wordElement);
    slot.classList.remove('filled');
  };
  return { initClickSelection };
})();

/* 用户界面模块（减少重复查询和使用被动触摸监听） */
const UI = (() => {
  const elements = {
    slot1: document.getElementById("slot1"),
    slot2: document.getElementById("slot2"),
    slot3: document.getElementById("slot3"),
    slot4: document.getElementById("slot4"),
    wordBank: document.getElementById("wordBank"),
    feedback: document.getElementById("feedback"),
    referenceAnswer: document.getElementById("referenceAnswer"),
    currentTranslation: document.getElementById("currentTranslation"),
    slot1Score: document.getElementById("slot1Score"),
    slot2Score: document.getElementById("slot2Score"),
    slot3Score: document.getElementById("slot3Score"),
    slot4Score: document.getElementById("slot4Score"),
    currentScore: document.getElementById("currentScore"),
    maxScore: document.getElementById("maxScore"),
    currentScoreContainer: document.getElementById("currentScoreContainer"),
    simpleModeBtn: document.getElementById("simpleModeBtn"),
    advancedModeBtn: document.getElementById("advancedModeBtn"),
    resetBtn: document.getElementById("resetBtn"),
    submitBtn: document.getElementById("submitBtn"),
    nextBtn: document.getElementById("nextBtn"),
    advancedTip: document.getElementById("advancedTip"),
    nextButtonWarning: document.getElementById("nextButtonWarning"),
    readingIndicator: document.getElementById("readingIndicator"),
    uploadBtn: document.getElementById("uploadBtn"),
    corpusFile: document.getElementById("corpusFile"),
    fileName: document.getElementById("fileName"),
    uploadStatus: document.getElementById("uploadStatus"),
    totalCompleted: document.getElementById("totalCompleted"),
    accuracy: document.getElementById("accuracy"),
    topErrors: document.getElementById("topErrors"),
    remainingQuestions: document.getElementById("remainingQuestions"),
    puzzleContainer: document.getElementById("puzzleContainer"),
    vocabContainer: document.getElementById("vocabContainer"),
    emptyState: document.getElementById("emptyState"),
    fetchJsonBtn: document.getElementById("fetchJsonBtn"),
    initialHint: document.getElementById("initialHint"),
    scoreDetailsEl: document.querySelector('.score-details'),
    referenceAnswerEl: document.querySelector('.reference-answer'),
    feedbackHeaderEl: document.querySelector('.feedback-header')
  }; 
  let isAdvancedMode = false;
  let isSubmitted = false;
  let nextButtonWarningShown = false;
  let currentSentence = null;
  let draggedElement = null;
  let currentFirstInitialSlot = 'slot1';

  const initDragAndDrop = () => {
    const slots = [elements.slot1, elements.slot2, elements.slot3, elements.slot4];
    slots.forEach(slot => {
      slot.addEventListener('touchmove', function(e) { e.preventDefault(); }, { passive: false });
      slot.addEventListener('touchend', function(e) {
        if (!draggedElement) return;
        e.preventDefault();
        if (this.firstChild) elements.wordBank.appendChild(this.firstChild);
        this.innerHTML = "";
        const clone = draggedElement.cloneNode(true);
        if (isAdvancedMode && this.id === currentFirstInitialSlot && clone.textContent) clone.textContent = clone.textContent.charAt(0).toUpperCase() + clone.textContent.slice(1);
        this.appendChild(clone);
        draggedElement.remove();
        draggedElement = null;
      }, { passive: false });
      slot.ondragover = e => e.preventDefault();
      slot.ondrop = e => {
        e.preventDefault();
        let data; try { data = JSON.parse(e.dataTransfer.getData("application/json")); } catch { return; }
        if (slot.firstChild) elements.wordBank.appendChild(slot.firstChild);
        slot.innerHTML = "";
        const el = document.createElement("div");
        el.className = "puzzle-piece";
        if (data.text === "." || data.text === "?") el.classList.add("punctuation");
        let displayText = data.text;
        if (isAdvancedMode && slot.id === currentFirstInitialSlot && displayText) displayText = displayText.charAt(0).toUpperCase() + displayText.slice(1);
        el.textContent = displayText;
        el.draggable = true;
        el.dataset.correctSlot = data.correctSlot;
        slot.appendChild(el);
        const bankKids = [...elements.wordBank.children];
        for (let i = 0; i < bankKids.length; i++) { if (bankKids[i].textContent === data.text) { bankKids[i].remove(); break; } }
      };
    });
  };

  const showAdvancedTip = () => {
    elements.advancedTip.textContent = AppConfig.uiStrings.chinese.advancedTip;
    elements.advancedTip.classList.add("show");
    setTimeout(() => { elements.advancedTip.classList.remove("show"); }, 3000);
  };
  const showNextButtonWarning = () => {
    elements.nextButtonWarning.textContent = AppConfig.uiStrings.chinese.nextButtonWarning;
    elements.nextButtonWarning.classList.add("show");
    setTimeout(() => { elements.nextButtonWarning.classList.remove("show"); }, 2000);
  };

  const populateVocabulary = () => {
    elements.vocabContainer.innerHTML = '';
    const vocab = Model.getVocabulary();
    AppConfig.vocabCategories.forEach(category => {
      const words = vocab[category.id];
      if (!words || words.size === 0) return;
      const section = document.createElement('div');
      section.className = 'vocab-block';
      section.style.backgroundColor = category.color;
      section.style.padding = '10px';
      section.style.borderRadius = '8px';
      section.style.marginBottom = '12px';
      const title = document.createElement('strong');
      title.textContent = category.name;
      section.appendChild(title);
      const container = document.createElement('div');
      container.className = 'vocab-container';
      words.forEach(word => {
        if (word === "") return;
        const item = document.createElement('span');
        item.className = 'vocab-item';
        item.textContent = word;
        container.appendChild(item);
      });
      section.appendChild(container);
      elements.vocabContainer.appendChild(section);
    });
  };

  const updateStatisticsDisplay = () => {
    const stats = Model.statistics;
    elements.totalCompleted.textContent = stats.totalCompleted;
    const accuracy = stats.totalCompleted > 0 ? (stats.perfectCount / stats.totalCompleted * 100).toFixed(0) : 0;
    elements.accuracy.textContent = `${accuracy}%`;
    if (stats.totalErrors >= 3) {
      let errorsArray = Object.entries(stats.errorCounts).sort((a, b) => {
        if (b[1] !== a[1]) return b[1] - a[1];
        const priority = { 'slot1': 1, 'slot2': 2, 'slot3': 3 };
        return priority[a[0]] - priority[b[0]];
      }).slice(0, 2);
      const errorNames = errorsArray.map(item => item[0] === 'slot1' ? '1位' : item[0] === 'slot2' ? '2位' : '其他位');
      elements.topErrors.textContent = errorNames.join(' ') || '无';
    } else {
      elements.topErrors.textContent = "-";
    }
    elements.remainingQuestions.textContent = Math.max(0, (Model.sentences?.length || 50) - stats.answeredCount);
  };

  const loadSentence = (sentence) => {
    [elements.slot1, elements.slot2, elements.slot3, elements.slot4].forEach(s => s.innerHTML = "");
    elements.wordBank.innerHTML = "";
    currentSentence = sentence;
    if (sentence.isCompleted) {
      elements.currentTranslation.textContent = sentence.translation;
      elements.wordBank.innerHTML = '<div class="puzzle-piece" style="background:#4CAF50;color:white;">练习已完成</div>';
      elements.nextBtn.disabled = true;
      elements.submitBtn.disabled = true;
      return;
    } else {
      elements.nextBtn.disabled = false;
      elements.submitBtn.disabled = false;
    }
    let pieces = [];
    if (isAdvancedMode) {
      pieces.push(
        {text: sentence.parts.slot1, correctSlot: "slot1"},
        {text: sentence.parts.slot2, correctSlot: "slot2"},
        {text: sentence.parts.slot3, correctSlot: "slot3"}
      );
      const puncts = [".", "?"];
      const correctPunct = sentence.parts.slot4;
      const wrongPunct = puncts.find(p => p !== correctPunct);
      pieces.push(
        {text: correctPunct, correctSlot: "slot4"},
        {text: wrongPunct, correctSlot: "none"}
      );
      const distractors = Algorithm.getDistractorWords(sentence);
      if (distractors.length > 0) pieces.push({text: distractors[Math.floor(Math.random() * distractors.length)], correctSlot: "none"});
      const hasEmptyInAnswer = [sentence.parts.slot1, sentence.parts.slot2, sentence.parts.slot3].some(x => x === "");
      const hasEmptyPiece = pieces.some(p => p.text === "");
      if (!hasEmptyInAnswer && !hasEmptyPiece) pieces.push({text: "", correctSlot: "none"});
      currentFirstInitialSlot = sentence.parts.slot1 !== "" ? "slot1" : (sentence.parts.slot2 !== "" ? "slot2" : "slot3");
    } else {
      pieces = [
        {text: sentence.parts.slot1 || "", correctSlot: "slot1"},
        {text: sentence.parts.slot2 || "", correctSlot: "slot2"},
        {text: (sentence.parts.slot3 || "") + (sentence.parts.slot4 || ""), correctSlot: "slot3"}
      ];
    }
    pieces.sort(() => Math.random() - 0.5);
    pieces.forEach(p => {
      const el = document.createElement("div");
      el.className = "puzzle-piece";
      if (p.text === "." || p.text === "?") el.classList.add("punctuation");
      let displayText = p.text;
      if (isAdvancedMode && typeof currentFirstInitialSlot !== "undefined" && p.correctSlot === currentFirstInitialSlot && displayText) {
        const m = displayText.match(/^([A-Za-zÄÖÜäöüß]+)/u);
        const firstWord = m ? m[1] : "";
        const lw = firstWord.toLowerCase();
        const pronouns = new Set(["ich","du","er","sie","es","wir","ihr"]);
        const isQ = (Model.vocabulary?.questionWords && Model.vocabulary.questionWords.has(lw));
        const isV = (Model.vocabulary?.verbs && Model.vocabulary.verbs.has(lw));
        let shouldLower = pronouns.has(lw) || lw === 'mein' || isQ || isV; if (firstWord === 'Sie') { shouldLower = false; }
        if (shouldLower) displayText = displayText.replace(/^(\p{L})/u, ch => ch.toLowerCase());
      }
      el.textContent = displayText;
      el.draggable = true;
      el.dataset.correctSlot = p.correctSlot;
      elements.wordBank.appendChild(el);
      el.addEventListener('touchstart', function(e) { e.preventDefault(); draggedElement = el; this.classList.add('dragging'); }, { passive: false });
      el.addEventListener('touchend', function() { this.classList.remove('dragging'); draggedElement = null; }, { passive: true });
      el.ondragstart = e => { try { e.dataTransfer.setData("application/json", JSON.stringify(p)); e.dataTransfer.effectAllowed = "move"; } catch(_) {} };
    });
    elements.referenceAnswer.textContent = sentence.full;
    elements.currentTranslation.textContent = sentence.translation;
    if (pieces.length > 0) elements.emptyState.classList.remove('show'); else { elements.emptyState.querySelector('p').textContent = AppConfig.uiStrings.chinese.emptyStateText; elements.emptyState.classList.add('show'); }
    isSubmitted = false;
    nextButtonWarningShown = false;
    elements.initialHint.style.display = 'block';
    elements.scoreDetailsEl.style.display = 'none';
    elements.referenceAnswerEl.style.display = 'none';
    elements.feedbackHeaderEl.style.display = 'none';
    setTimeout(() => { Speech.speakChinese(sentence.translation); }, 500);
  };

  const showScoreFeedback = (scoreResult) => {
    const { scores, total } = scoreResult;
    elements.slot1Score.textContent = scores.slot1;
    elements.slot2Score.textContent = scores.slot2;
    elements.slot3Score.textContent = scores.slot3;
    elements.slot4Score.textContent = isAdvancedMode ? scores.slot4 : "-";
    elements.currentScore.textContent = total;
    elements.maxScore.textContent = 5;
    elements.currentScoreContainer.classList.remove("high", "low");
    elements.currentScoreContainer.classList.add(total >= 4 ? "high" : "low");
    elements.feedback.style.display = "block";
    elements.scoreDetailsEl.style.display = 'grid';
    elements.referenceAnswerEl.style.display = 'block';
    elements.feedbackHeaderEl.style.display = 'flex';
    elements.initialHint.style.display = 'none';
    document.querySelectorAll('.score-item').forEach(item => item.classList.remove('error'));
    if (isAdvancedMode) {
      if (scores.slot1 < AppConfig.slots.scoring.advanced.slot1) elements.slot1Score.parentNode.classList.add('error');
      if (scores.slot2 < AppConfig.slots.scoring.advanced.slot2) elements.slot2Score.parentNode.classList.add('error');
      if (scores.slot3 < AppConfig.slots.scoring.advanced.slot3) elements.slot3Score.parentNode.classList.add('error');
      if (scores.slot4 < AppConfig.slots.scoring.advanced.slot4) elements.slot4Score.parentNode.classList.add('error');
    } else {
      if (scores.slot1 < AppConfig.slots.scoring.simple.slot1) elements.slot1Score.parentNode.classList.add('error');
      if (scores.slot2 < AppConfig.slots.scoring.simple.slot2) elements.slot2Score.parentNode.classList.add('error');
      if (scores.slot3 < AppConfig.slots.scoring.simple.slot3) elements.slot3Score.parentNode.classList.add('error');
    }
    isSubmitted = true;
    Model.updateStatistics(scoreResult, isAdvancedMode);
    updateStatisticsDisplay();
    if (total === 5) Speech.speakGerman(currentSentence.full);
  };

  const refreshUI = () => {
    populateVocabulary();
    currentSentence = Model.getRandomSentence();
    loadSentence(currentSentence);
    updateStatisticsDisplay();
  };

  const initFileUpload = () => {
    elements.uploadBtn.addEventListener('click', () => elements.corpusFile.click(), { passive: true });
    elements.corpusFile.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      elements.fileName.textContent = file.name;
      elements.uploadStatus.textContent = '正在加载语料库...';
      elements.uploadStatus.className = 'upload-status';
      elements.uploadStatus.style.display = 'block';
      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const raw = event.target.result;
          const data = Decryptor.decryptCorpusIfNeeded(raw);
          if (!data.sentences || !Array.isArray(data.sentences)) throw new Error('无效的语料库格式: 缺少句子数据');
          Model.loadCorpus(data);
          elements.uploadStatus.textContent = '语料库加载成功！';
          elements.uploadStatus.className = 'upload-status success';
          refreshUI();
        } catch (error) {
          elements.uploadStatus.textContent = '加载失败: ' + error.message;
          elements.uploadStatus.className = 'upload-status error';
          console.error('语料库加载错误:', error);
        }
      };
      reader.onerror = function() { elements.uploadStatus.textContent = '文件读取失败'; elements.uploadStatus.className = 'upload-status error'; };
      reader.readAsText(file);
    });
  };
  
  const initRemoteLoader = () => {
    elements.fetchJsonBtn.addEventListener('click', async () => {
      try {
        const corpusData = await RemoteLoader.loadRemoteCorpus();
        Model.loadCorpus(corpusData);
        elements.fileName.textContent = "云端语料库";
        refreshUI();
        setTimeout(() => { alert("云端语料库加载成功！已加载" + Model.sentences.length + "个句子"); }, 300);
      } catch (_) {}
    });
  };

  const initUI = () => {
    isAdvancedMode = false;
    elements.slot4.style.display = "none";
    elements.puzzleContainer.classList.add('simple-mode');
    elements.emptyState.querySelector('p').textContent = AppConfig.uiStrings.chinese.emptyStateText;
    populateVocabulary();
    currentSentence = Model.getRandomSentence();
    loadSentence(currentSentence);
    initDragAndDrop();
    initFileUpload();
    initRemoteLoader();
    updateStatisticsDisplay();
    window.UI = { isAdvancedMode, currentFirstInitialSlot };
    elements.simpleModeBtn.addEventListener("click", () => {
      isAdvancedMode = false; window.UI.isAdvancedMode = false;
      elements.simpleModeBtn.classList.add("active");
      elements.advancedModeBtn.classList.remove("active");
      elements.slot4.style.display = "none";
      elements.puzzleContainer.classList.add('simple-mode');
      currentSentence = Model.getRandomSentence();
      loadSentence(currentSentence);
    });
    elements.advancedModeBtn.addEventListener("click", () => {
      isAdvancedMode = true; window.UI.isAdvancedMode = true;
      elements.advancedModeBtn.classList.add("active");
      elements.simpleModeBtn.classList.remove("active");
      elements.slot4.style.display = "block";
      elements.puzzleContainer.classList.remove('simple-mode');
      currentSentence = Model.getRandomSentence();
      loadSentence(currentSentence);
      showAdvancedTip();
    });
    elements.resetBtn.addEventListener("click", () => loadSentence(currentSentence));
    elements.nextBtn.addEventListener("click", () => {
      if (!isSubmitted && !nextButtonWarningShown) { showNextButtonWarning(); nextButtonWarningShown = true; return; }
      currentSentence = Model.getRandomSentence();
      loadSentence(currentSentence);
    });
    elements.submitBtn.addEventListener("click", () => {
      if (currentSentence.isCompleted) return;
      const userAnswers = {
        slot1: elements.slot1.firstChild?.textContent || "",
        slot2: elements.slot2.firstChild?.textContent || "",
        slot3: elements.slot3.firstChild?.textContent || "",
        slot4: elements.slot4.firstChild?.textContent || ""
      };
      const scoreResult = Algorithm.calculateScore(userAnswers, currentSentence.parts, isAdvancedMode);
      showScoreFeedback(scoreResult);
    });
    document.addEventListener("drop", e => e.preventDefault(), false);
    document.addEventListener("dragover", e => e.preventDefault(), false);
  };

  return { initUI };
})();

document.addEventListener('DOMContentLoaded', () => {
  UI.initUI();
  document.getElementById('wordBank').addEventListener('click', function() {
    this.classList.add('active');
    setTimeout(() => this.classList.remove('active'), 300);
  }, { passive: true });
  MobileClick.initClickSelection();
});
</script>
</body>
</html>
