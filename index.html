<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>深圳德语(⭐)陈老师讲德语 - 什么变位动词</title>
<style>
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;
    min-height:100vh;
    background:linear-gradient(135deg,rgba(26,42,108,0.9),rgba(178,31,31,0.9),rgba(26,42,108,0.9));
    background-repeat:no-repeat;background-size:cover;background-position:center;
  }
  header{padding:14px 16px;background:#1a2a6c;color:#fff;box-shadow:0 2px 8px rgba(0,0,0,.2)}
  h1{margin:0;font-size:1.1rem}
  .container{max-width:1000px;margin:0 auto;padding:14px}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:10px 0}
  .mode{display:flex;gap:8px}
  .btn{cursor:pointer;border:0;background:#eee;color:#333;padding:8px 12px;border-radius:8px;font-weight:600}
  .btn.primary{background:#ffcc00;color:#1a2a6c}
  .btn.success{background:#28a745;color:#fff}
  .btn.secondary{background:#6c757d;color:#fff}
  .btn.active{outline:2px solid #ffcc00}
  .row{display:flex;flex-direction:column;gap:10px}
  .panel{background:#f7f7fb;border:1px solid #e3e6ef;border-radius:10px;padding:12px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
  .title-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  .title{font-weight:700;color:#1a2a6c}
  .progress{font-weight:700;color:#1a2a6c}
  .bank,.sentence{display:flex;flex-wrap:wrap;gap:8px;min-height:60px}
  .piece{background:#e3f2fd;color:#0b4167;border:1px solid #c7e5ff;padding:8px 12px;border-radius:8px;font-weight:700;cursor:move;user-select:none;position:relative}
  .piece.stem{background:#e9e7ff;border-color:#c9c6ff;color:#2d1f8b;transform:scaleY(0.75)}
  /* Girdle (saddle) */
  .piece.girdle{background:#fff0d6;border-color:#ffd27a;color:#7a4f00;display:flex;align-items:stretch;gap:6px;padding:6px 10px}
  .g-left,.g-right{background:#ffe6b3;border:1px solid #ffc76a;color:#7a4f00;border-radius:6px;padding:6px 8px;font-weight:700;display:flex;align-items:center}
  .g-center{display:flex;flex-direction:column;align-items:stretch;justify-content:flex-start;border-radius:6px;min-width:60px}
  .g-connector{background:#ffe6b3;border:1px solid #ffc76a;border-radius:6px 6px 0 0}
  .g-hole{flex:1;border-radius:0 0 6px 6px}
  .bank .g-hole{background:#f7f7fb}
  .sentence .g-hole{background:#fff}
  .g-stem{flex:1;display:flex;align-items:center;justify-content:center;border-radius:0 0 6px 6px;background:#e9e7ff;border:1px solid #c9c6ff;color:#2d1f8b;font-weight:700}
  .piece.ghost{opacity:.6}
  .sentence{background:#fff;border:2px dashed #b9c3d1;border-radius:10px;padding:10px}
  .sentence .piece.stem.attach-highlight{box-shadow:0 0 0 3px rgba(255,204,0,0.6) inset}
  .drop-hint{opacity:0.7;font-style:italic;color:#666}
  .status{font-weight:700}
  .ok{color:#28a745}.bad{color:#c0392b}
  .ref{background:#fff;border-left:4px solid #1a2a6c;padding:8px;border-radius:8px}
  @media (max-width:680px){
    .bank,.sentence{gap:6px}
    .piece{padding:6px 9px}
    .g-left,.g-right{padding:5px 7px}
  }
</style>
</head>
<body>
<header>
  <h1>深圳德语(⭐)陈老师讲德语 - 什么变位动词</h1>
</header>

<div class="container">
  <div class="toolbar">
    <div class="mode">
      <button id="modeClassical" class="btn active">科班老师模式</button>
      <button id="modeXiexiu" class="btn">陈老师邪修模式</button>
    </div>
    <div style="flex:1"></div>
    <button id="btnReset" class="btn secondary">重置拼图</button>
    <button id="btnSubmit" class="btn primary">提交答案</button>
    <button id="btnNext" class="btn success">下一题</button>
  </div>

  <div class="row">
    <div class="panel">
      <div class="title-row">
        <div class="title">请造句</div>
        <div class="progress">第 <span id="idx">1</span>/5 题</div>
      </div>
      <div id="target" style="font-weight:700"></div>
    </div>

    <div class="panel">
      <div class="title">拼图区（拖拽到此处，并可在此区域内拖动改变顺序）</div>
      <div id="sentence" class="sentence" data-zone="sentence">
        <span class="drop-hint" id="hintSentence">将下方拼图拖到此处</span>
      </div>
    </div>

    <div class="panel">
      <div class="title">拼图块</div>
      <div id="bank" class="bank" data-zone="bank"></div>
    </div>

    <div class="panel">
      <div class="title">结果</div>
      <div id="status" class="status"></div>
      <div id="ref" class="ref" style="margin-top:8px;display:none"></div>
    </div>
  </div>
</div>

<script>
(function(){
  const exercises = [
    {
      text: "Wir sprechen heute Deutsch.",
      cn: "我们今天说德语。",
      classical: ["Wir","sprechen","heute","Deutsch."],
      xiexiu: [
        {type:"stem", text:"sprech", stem:"sprech"},
        {type:"word", text:"heute"},
        {type:"word", text:"Deutsch."},
        {type:"girdle", subject:"wir", leftLabel:"wir-", rightLabel:"-en", suffix:"en"}
      ]
    },
    {
      text: "Woher kommst du?",
      cn: "你来自哪里？",
      classical: ["Woher","kommst","du?"],
      xiexiu: [
        {type:"stem", text:"komm", stem:"komm"},
        {type:"word", text:"Woher"},
        {type:"girdle", subject:"du", leftLabel:"du-", rightLabel:"-st", suffix:"st"},
        {type:"word", text:"?"}
      ]
    },
    {
      text: "Heute sprechen wir Deutsch.",
      cn: "今天我们说德语。",
      classical: ["Heute","sprechen","wir","Deutsch."],
      xiexiu: [
        {type:"stem", text:"sprech", stem:"sprech"},
        {type:"word", text:"Heute"},
        {type:"word", text:"Deutsch."},
        {type:"girdle", subject:"wir", leftLabel:"wir-", rightLabel:"-en", suffix:"en"}
      ]
    },
    {
      text: "Ich bin Herr Chen.",
      cn: "我是陈先生。",
      classical: ["Ich","bin","Herr","Chen."],
      xiexiu: [
        {type:"word", text:"Ich"},
        {type:"word", text:"bin"},
        {type:"word", text:"Herr"},
        {type:"word", text:"Chen."}
      ]
    },
    {
      text: "Herr Chen bin ich.",
      cn: "陈先生是我。",
      classical: ["Herr","Chen","bin","ich."],
      xiexiu: [
        {type:"word", text:"Herr"},
        {type:"word", text:"Chen"},
        {type:"word", text:"bin"},
        {type:"word", text:"ich."}
      ]
    }
  ];

  let mode = "classical";
  let index = 0;
  let dragData = null;
  let hoverStemEl = null;

  const elIdx = document.getElementById("idx");
  const elTarget = document.getElementById("target");
  const elBank = document.getElementById("bank");
  const elSentence = document.getElementById("sentence");
  const elHintSentence = document.getElementById("hintSentence");
  const elStatus = document.getElementById("status");
  const elRef = document.getElementById("ref");
  const btnReset = document.getElementById("btnReset");
  const btnSubmit = document.getElementById("btnSubmit");
  const btnNext = document.getElementById("btnNext");
  const btnModeClassical = document.getElementById("modeClassical");
  const btnModeXiexiu = document.getElementById("modeXiexiu");

  function normalize(text){
    return text
      .replace(/\s+/g," ")
      .replace(/\s+([?.!,:;])/g,"$1")
      .trim();
  }
  function renderTarget(){
    elIdx.textContent = String(index+1);
    elTarget.textContent = exercises[index].cn;
  }
  function clearZone(zone){
    while(zone.firstChild) zone.removeChild(zone.firstChild);
  }
  function updateGirdleDimensions(girdle){
    const center = girdle.querySelector('.g-center');
    const connector = girdle.querySelector('.g-connector');
    if(!center || !connector) return;
    const baseH = girdle.getBoundingClientRect().height || 40;
    connector.style.height = Math.max(8, Math.round(baseH*0.25)) + 'px';
  }
  function setGirdleCenterWidth(girdle, w){
    const center = girdle.querySelector('.g-center');
    if(center){ center.style.width = Math.max(40, Math.round(w)) + 'px'; }
  }
  function makeGirdleInner(data){
    const wrap = document.createElement('div');
    wrap.className = 'piece girdle';
    wrap.dataset.kind = 'girdle';
    wrap.dataset.subject = data.subject;
    wrap.dataset.suffix = data.suffix;
    const left = document.createElement('div');
    left.className = 'g-left';
    left.textContent = data.leftLabel || (data.subject + '-');
    const center = document.createElement('div');
    center.className = 'g-center';
    const connector = document.createElement('div');
    connector.className = 'g-connector';
    const hole = document.createElement('div');
    hole.className = 'g-hole';
    center.appendChild(connector);center.appendChild(hole);
    const right = document.createElement('div');
    right.className = 'g-right';
    right.textContent = data.rightLabel || ('-' + data.suffix);
    wrap.appendChild(left);wrap.appendChild(center);wrap.appendChild(right);
    return wrap;
  }
  function makePiece(data){
    if(data.type==="girdle"){
      const girdle = makeGirdleInner(data);
      bindDnD(girdle, {
        kind:'girdle',
        subject:data.subject||'',
        suffix:data.suffix||'',
        text:''
      });
      // initial size from any stem in bank
      const refStem = elBank.querySelector('.piece.stem');
      if(refStem) setGirdleCenterWidth(girdle, refStem.getBoundingClientRect().width);
      // defer dimension calc after insertion
      setTimeout(()=>updateGirdleDimensions(girdle));
      return girdle;
    }

    const div = document.createElement("div");
    div.className = "piece";
    div.draggable = true;

    if(data.type==="stem"){
      div.classList.add("stem");
      div.dataset.kind = "stem";
      div.dataset.stem = data.stem;
      div.textContent = data.text;
    }else{
      div.dataset.kind = "word";
      div.textContent = data.text;
    }

    bindDnD(div, {
      kind: div.dataset.kind,
      subject: div.dataset.subject||"",
      suffix: div.dataset.suffix||"",
      stem: div.dataset.stem||"",
      text: div.textContent
    });
    return div;
  }

  function bindDnD(div, payload){
    div.addEventListener("dragstart", e=>{
      dragData = {
        from: div.parentElement.getAttribute("data-zone"),
        html: div.outerHTML,
        payload: payload,
        sourceEl: div
      };
      setTimeout(()=>div.classList.add("ghost"),0);
      e.dataTransfer.effectAllowed = "move";
    });
    div.addEventListener("dragend", ()=>{
      if(hoverStemEl){ hoverStemEl.classList.remove('attach-highlight'); hoverStemEl=null; }
      div.classList.remove("ghost");
      dragData = null;
    });
  }

  function populateBank(){
    clearZone(elBank);
    const ex = exercises[index];
    const pieces = mode==="classical"
      ? ex.classical.map(t=>({type:"word",text:t}))
      : ex.xiexiu;

    const shuffled = pieces.slice().sort(()=>Math.random()-0.5);
    shuffled.forEach(p=>{
      const el = makePiece(p);
      elBank.appendChild(el);
      if(el.classList.contains('girdle')) updateGirdleDimensions(el);
    });
  }

  function refreshAll(){
    elStatus.textContent = "";
    elStatus.className = "status";
    elRef.style.display = "none";
    elRef.textContent = "";
    clearZone(elSentence);
    elHintSentence.style.display = "inline";
    populateBank();
    renderTarget();
  }

  function insertPieceIntoSentence(html, beforeEl=null){
    const temp = document.createElement("div");
    temp.innerHTML = html;
    const piece = temp.firstElementChild;
    if(beforeEl){
      elSentence.insertBefore(piece, beforeEl);
    }else{
      elSentence.appendChild(piece);
    }
    // Rebind after DOM insertion
    if(piece.classList.contains('girdle')){
      bindDnD(piece, {
        kind:'girdle',
        subject: piece.dataset.subject||'',
        suffix: piece.dataset.suffix||'',
        text: ''
      });
      updateGirdleDimensions(piece);
    }else{
      bindDnD(piece, {
        kind: piece.dataset.kind,
        subject: piece.dataset.subject||'',
        suffix: piece.dataset.suffix||'',
        stem: piece.dataset.stem||'',
        text: piece.textContent
      });
    }
  }

  function rebindPiece(div){
    bindDnD(div, {
      kind: div.dataset.kind,
      subject: div.dataset.subject||"",
      suffix: div.dataset.suffix||"",
      stem: div.dataset.stem||"",
      text: div.textContent
    });
  }

  let sentenceInsertBefore = null;
  elSentence.addEventListener("dragover", e=>{
    e.preventDefault();
    const target = e.target.closest(".piece");
    sentenceInsertBefore = target && target.parentElement===elSentence ? target : null;

    if(dragData && dragData.payload && dragData.payload.kind==='girdle'){
      const girdle = dragData.sourceEl && dragData.sourceEl.classList.contains('girdle') ? dragData.sourceEl : null;
      const stem = target && target.dataset && target.dataset.kind==='stem' ? target : null;
      if(hoverStemEl && hoverStemEl!==stem){ hoverStemEl.classList.remove('attach-highlight'); hoverStemEl=null; }
      if(stem){
        stem.classList.add('attach-highlight'); hoverStemEl=stem;
        if(girdle){ setGirdleCenterWidth(girdle, stem.getBoundingClientRect().width); updateGirdleDimensions(girdle); }
      }
    }
  });

  // General drop (bubble)
  elSentence.addEventListener("drop", e=>{
    e.preventDefault();
    if(!dragData) return;
    const from = dragData.from;

    // If special merge will handle, skip generic insert
    const dropTargetPiece = e.target.closest('.piece');
    if(dragData.payload.kind==='girdle' && dropTargetPiece && dropTargetPiece.dataset.kind==='stem'){
      return; // let capture handler do merge
    }

    if(from==="bank" || from==="sentence"){
      if(dragData.sourceEl && dragData.sourceEl.parentElement){
        dragData.sourceEl.parentElement.removeChild(dragData.sourceEl);
      }
      insertPieceIntoSentence(dragData.html, sentenceInsertBefore);
      elHintSentence.style.display = elSentence.children.length ? "none" : "inline";
    }
  });

  elBank.addEventListener("dragover", e=>{ e.preventDefault(); });
  elBank.addEventListener("drop", e=>{
    e.preventDefault();
    if(!dragData) return;
    if(dragData.sourceEl && dragData.sourceEl.parentElement){
      dragData.sourceEl.parentElement.removeChild(dragData.sourceEl);
    }
    const temp = document.createElement("div");
    temp.innerHTML = dragData.html;
    const piece = temp.firstElementChild;
    elBank.appendChild(piece);
    rebindPiece(piece);
    if(piece.classList.contains('girdle')) updateGirdleDimensions(piece);
  });

  // Special merge (capture) for girdle -> stem
  elSentence.addEventListener("drop", e=>{
    const dropTargetPiece = e.target.closest(".piece");
    if(!dropTargetPiece || !dragData) return;

    const dragged = dragData.payload;
    const targetKind = dropTargetPiece.dataset.kind;

    if(dragged.kind==="girdle" && targetKind==="stem"){
      e.preventDefault();
      // Remove original dragged element (from bank or sentence)
      if(dragData.sourceEl && dragData.sourceEl.parentElement){
        dragData.sourceEl.parentElement.removeChild(dragData.sourceEl);
      }
      // Build composite girdle with stem filled into the center
      const subjectCap = (dragged.subject||'').replace(/^(\w)/, (m)=>m.toUpperCase());
      const suffix  = dragged.suffix;
      const stem    = dropTargetPiece.dataset.stem || "";
      const verb = stem + suffix;

      const composite = makeGirdleInner({
        subject: dragged.subject,
        leftLabel: (dragged.subject||'')+'-',
        rightLabel: '-' + suffix,
        suffix: suffix
      });
      const center = composite.querySelector('.g-center');
      const hole = composite.querySelector('.g-hole');
      const connector = composite.querySelector('.g-connector');
      const stemSlot = document.createElement('div');
      stemSlot.className = 'g-stem';
      stemSlot.textContent = verb;
      center.replaceChild(stemSlot, hole);
      // reading output
      composite.dataset.output = subjectCap + ' ' + verb;
      // size to match target stem
      const w = dropTargetPiece.getBoundingClientRect().width;
      setGirdleCenterWidth(composite, w);
      updateGirdleDimensions(composite);
      // insert at stem position
      const parent = dropTargetPiece.parentElement;
      const marker = dropTargetPiece.nextSibling;
      if(dropTargetPiece.parentElement) dropTargetPiece.parentElement.removeChild(dropTargetPiece);
      parent.insertBefore(composite, marker);
      bindDnD(composite, { kind:'compound', text: composite.dataset.output });
      if(hoverStemEl){ hoverStemEl.classList.remove('attach-highlight'); hoverStemEl=null; }
      // consume
      dragData = null;
    }
  }, true);

  function readSentenceText(){
    const tokens = [...elSentence.querySelectorAll(".piece")].map(p=>{
      const out = p.dataset && p.dataset.output ? p.dataset.output : p.textContent.trim();
      return out.trim();
    });
    let s = tokens.join(" ");
    s = s.replace(/\s+\?/g,"?").replace(/\s+\./g,".");
    s = s.replace(/\s+([?!.,;:])/g,"$1");
    return normalize(s);
  }

  function submit(){
    const user = readSentenceText();
    const ans  = normalize(exercises[index].text);
    if(user===ans){
      elStatus.textContent = "✅ 正确！";
      elStatus.className = "status ok";
      elRef.style.display = "none";
    }else{
      elStatus.textContent = "❌ 还差一点，再试试！";
      elStatus.className = "status bad";
      elRef.style.display = "block";
      elRef.textContent = "参考答案： " + exercises[index].text;
    }
  }

  btnReset.addEventListener("click", ()=>refreshAll());
  btnSubmit.addEventListener("click", submit);
  btnNext.addEventListener("click", ()=>{
    index = (index+1) % exercises.length;
    refreshAll();
  });

  btnModeClassical.addEventListener("click", ()=>{
    mode = "classical";
    btnModeClassical.classList.add("active");
    btnModeXiexiu.classList.remove("active");
    refreshAll();
  });
  btnModeXiexiu.addEventListener("click", ()=>{
    mode = "xiexiu";
    btnModeXiexiu.classList.add("active");
    btnModeClassical.classList.remove("active");
    refreshAll();
  });

  // 自动初始化
  refreshAll();
})();
</script>
</body>
</html>